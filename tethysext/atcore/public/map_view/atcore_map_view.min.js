var ATCORE_MAP_VIEW=function(){"use strict";var e,t,a,o,l,n,r,i,s,c,d,u,p,y,f,m,h,g,v,_,b,x,S,w,E,k,T,L,P,A,C,V,M,R,O,I,W,Y,H,U,j,N,F,z,G,q,X,D,K,Z,B,J,Q,ee,te,ae,oe,le,ne,re,ie,se,ce,de,ue,pe,ye,fe,me,he,ge;return h=function(){var e=$("#atcore-map-attributes");e.data("layer-groups"),l=e.data("map-extent"),o=e.data("workspace"),n=e.data("enable-properties-popup")},g=function(){var e=$("#atcore-map-permissions");f=e.data("can-use-geocode"),m=e.data("can-use-plot")},v=function(){$.ajaxSetup({beforeSend:function(e,t){/^http:.*/.test(t.url)||/^https:.*/.test(t.url)||e.setRequestHeader("X-CSRFToken",get_csrf_token())}})},_=function(){$('button[title="Fit to extent"]').html('<span class="glyphicon glyphicon-home"></span>'),t=TETHYS_MAP_VIEW.getMap(),TETHYS_MAP_VIEW.zoomToExtent(l),a={},t.getLayers().forEach(function(e,t,o){"tethys_data"in e&&"layer_id"in e.tethys_data&&(e.tethys_data.layer_id in a&&console.log('Warning: layer_name already in layers map: "'+e.tethys_data.layer_id+'".'),a[e.tethys_data.layer_id]=e)}),ae()},x=function(e){t.removeLayer(a[e]),delete a[e]},L=function(){if(!m)return;p="map-plot",y={scrollZoom:!0};M("Plot Title",[],{autosize:!0,height:415,margin:{l:80,r:80,t:20,b:80},xaxis:{title:"X Axis Title"},yaxis:{title:"Y Axis Title"}}),$(window).resize(function(){V()}),$(".toggle-nav").on("tethys:toggle-nav",function(e){V()})},M=function(e,t,a){let o=Plotly.validate(t,a);o?$(o).each(function(e,t){console.error(t.msg)}):Plotly.react(p,t,a,y).then(function(t){V(),$("#plot-slide-sheet .slide-sheet-title").html(e)})},P=function(e){if(!m)return;let t=S(e),o=w(e),l=a[t];return l&&l.tethys_data.plottable?'<div class="plot-btn-wrapper"><a class="btn btn-primary btn-popup" href="javascript:void(0);" role="button"data-feature-id="'+o+'"data-layer-id="'+t+'">Plot</a></div>':void 0},E=function(e){if(!m)return;let t=S(e),o=w(e),l=a[t];return l&&l.tethys_data.has_action?'<div class="action-btn-wrapper"><a class="btn btn-primary btn-popup" href="javascript:void(0);" role="button"data-feature-id="'+o+'"data-layer-id="'+t+'">Action</a></div>':void 0},A=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");C(e.target,t,a)})},k=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");T(e.target,t,a)})},C=function(e,t,a){$(e).attr("disabled","disabled"),$.ajax({url:".",type:"POST",data:{method:"get-plot-data",layer_name:t,feature_id:a}}).done(function(t){M(t.title,t.data,t.layout),R(),$(e).removeAttr("disabled")})},T=function(e,t,a){},V=function(){let e=$("#plot-slide-sheet").width();Plotly.relayout(p,{width:e})},R=function(){SLIDE_SHEET.open("plot-slide-sheet")},O=function(){SLIDE_SHEET.close("plot-slide-sheet")},se=function(){$("#action-modal").on("hide.bs.modal",function(e){$("#action-modal #do-action-button").off("click")}),$("#action-modal").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()})},ce=function(e,t,a,o){let l=$("#action-modal"),n=$("#action-modal #action-modal-title"),r=$("#action-modal #action-modal-content"),i=$("#action-modal #do-action-button");return n.html(e),r.html(t),i.html(a),i.attr("class","btn btn-"+o),{modal:l,title:n,content:r,action_button:i}},de=function(){$("#action-modal").modal("show")},ue=function(){$("#action-modal").modal("hide")},I=function(){se(),W(),Y(),H(),G(),U(),j(),z(),F(),N()},W=function(){let e={};$('input[type="radio"]').on("click",function(){this.name in e?this!=e[this.name]?($(e[this.name]).trigger("deselect"),e[this.name]=this):(this.checked=!1,$(this).trigger("deselect"),delete e[this.name]):e[this.name]=this}).filter(":checked").each(function(){e[this.name]=this}),$(".layer-group-visibility-control").on("change",function(e){let t=$(e.target),o=t.is(":checked"),l=t.closest(".layer-group-item").next(".layer-list");J(),l.find(".layer-visibility-control").each(function(e,t){let l=$(t);l.prop("disabled",!o);let n=l.data("layer-id"),r=l.is(":checked"),i=l.data("layer-variable");a[n].setVisible(o&&r),o&&r?$("#legend-"+i).removeClass("hidden"):$("#legend-"+i).addClass("hidden")}),l.find(".layers-context-menu").each(function(e,t){let a=$(t).find(".dropdown-toggle");o?a.removeClass("disabled"):a.addClass("disabled")})}),$(".layer-visibility-control").on("change",function(e){let t=$(e.target),o=t.is(":checked"),l=t.data("layer-id"),n=t.data("layer-variable");J(),a[l].setVisible(o),$("#legend-"+n).removeClass("hidden")}),$(".layer-visibility-control").on("deselect",function(e){let t=$(e.target),o=t.is(":checked"),l=t.data("layer-id"),n=t.data("layer-variable");a[l].setVisible(o),$("#legend-"+n).addClass("hidden")})},Y=function(){$(".layer-opacity-control").on("input",function(e){let t=$(e.target),o=t.val();t.prev("label").children(".slider-value").first().html(o+"%");let l=t.data("layer-id");a[l].setOpacity(o/100)})},H=function(){$(".rename-action").on("click",function(e){let t=$(e.target);t.hasClass("rename-action")||(t=t.closest(".rename-action"));let a=t.closest(".layers-context-menu").prev().find(".display-name").first(),o=a.html(),l=ce("Rename Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" value="'+o+'" autofocus onfocus="this.select();"></div>',"Rename","success");de(),l.action_button.on("click",function(e){let t=l.content.find("#new-name-field").first().val();a.html(t),ue()})})},U=function(){$(".remove-action").on("click",function(e){let t=$(e.target);t.hasClass("remove-action")||(t=t.closest(".remove-action"));let a=t.data("remove-type"),o=t.closest(".layers-context-menu").prev().find(".display-name").first().html(),l="",n="";"layer"===a?(l="Remove Layer",n='<p>Are you sure you want to remove the "'+o+'" layer?</p>'):(l="Remove Layer Group",n='<p>Are you sure you want to remove the "'+o+'" layer group and all of its layers?</p>');let r=ce(l,n,"Remove","danger");de(),r.action_button.on("click",function(e){J();if("layer"===a){var o=t.data("layer-id");x(o),t.closest(".layer-list-item").remove()}else{let e=t.closest(".layer-group-item"),a=e.next(".layer-list");a.find(".layer-visibility-control").each(function(e,t){let a=$(t).data("layer-id");x(a)}),e.remove(),a.remove()}ue(),"layer"===a&&(b=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"remove_custom_layer",layer_group_type:"custom_layers",layer_id:o},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",b)}}).done(function(e){}))})})},G=function(){$(".layer-dropdown-toggle").on("switchChange.bootstrapSwitch",function(e,t){$(e.target).closest(".layers-context-menu").prev().find(".display-name").first().html()})},j=function(){$(".zoom-to-layer-action").on("click",function(e){let t=$(e.target);t.hasClass("zoom-to-layer-action")||(t=t.closest(".zoom-to-layer-action"));let o=t.data("layer-id"),n=a[o].getExtent();n?TETHYS_MAP_VIEW.zoomToExtent(n):TETHYS_MAP_VIEW.zoomToExtent(l)})},N=function(){$(".collapse-action").on("click",function(e){let t=$(e.target);t.hasClass("collapse-action")||(t=t.closest(".collapse-action"));let a=t.closest(".layer-group-item").next(".layer-list");a.data("collapsed")||!1?(expand_section(a.get(0)),a.data("collapsed",!1),t.data("collapsed",!1)):(collapse_section(a.get(0)),a.data("collapsed",!0),t.data("collapsed",!0))})},z=function(){},F=function(){$(".add-layer-to-layer-group").on("click",function(e){let o=$(e.target);o.hasClass("add-layer-to-layer-group")||(o=o.closest(".add-layer-to-layer-group"));let l=o.closest(".layers-context-menu").prev(),n=(l.find(".display-name").first(),l.parent().next().first());var r=ge();let i=ce("Add Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" style="margin-bottom:10px" value="New Layer" autofocus onfocus="this.select();"><label class="sr-only" for="service-type">Map Service Type</label><select class="form-control" style="margin-bottom:10px" id="service-type"><option value="WMS" selected>WMS</option></select><label class="sr-only" for="services-link">Service Link</label><input class="form-control" type="text" id="services-link" value="https://mrdata.usgs.gov/services/sgmc2" placeholder="Service Link (ex: https://mrdata.usgs.gov/services/sgmc2)" autofocus onfocus="this.select();"><label class="sr-only" for="service-layer-name">Layer Name</label><input class="form-control" type="text" id="service-layer-name" value="Lithology" placeholder="Layer Name (ex: Lithology)" style="margin-top: 10px" autofocus onfocus="this.select();"></div>',"Add","success");de(),i.action_button.on("click",function(e){let o=i.content.find("#new-name-field").first().val(),l=i.content.find("#service-type").first().val(),s=i.content.find("#services-link").first().val(),c=i.content.find("#service-layer-name").first().val(),d='<li class="layer-list-item">';d+='<label class="flatmark"><span class="display-name">'+o+"</span>",d+='<input type="checkbox" class="layer-visibility-control" checked id="'+r+'"',d+='data-layer-id="'+r+'" data-layer-variable="" name="custom_layers">',d+='<span class="checkmark checkbox"></span></label>',d+='<div class="dropdown layers-context-menu pull-right">',d+='<a id="'+r+'--context-menu" class="btn btn-xs dropdown-toggle layers-btn " data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="color: rgb(186, 12, 47);">',d+='<span class="glyphicon glyphicon-option-vertical"></span></a>',d+='<ul class="dropdown-menu dropdown-menu-right" aria-labeledby="'+r+'--context-menu">',d+='<li><a class="rename-action" href="javascript:void(0);" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-pencil"></span><span class="command-name">Rename</span></a></li>',d+='<li><a class="remove-action" href="javascript:void(0);" data-remove-type="layer" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-remove"></span><span class="command-name">Remove</span></a></li>',d+='<li role="separator" class="divider"></li>',d+='<li><a class="zoom-to-layer-action" href="javascript:void(0);" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-fullscreen"></span><span class="command-name">Zoom to Layer</span></a></li>',d+='<li role="separator" class="divider"></li>',d+="<li>",d+='<div class="flat-slider-container">',d+='<label><span class="glyphicon glyphicon-adjust"></span><span class="command-name">Opacity: </span><span class="slider-value">100%</span></label>',d+='<div class="flat-slider-container">',d+='<input type="range" class="flat-slider layer-opacity-control" min="0" max="100" value="100" data-layer-id="'+r+'" data-layer-variable="">',d+="</div>",d+="</li></ul>",n.append(d),n.css({overflow:"visible"});var u=new ol.layer.Tile({source:new ol.source.TileWMS({url:s,params:{service:l,version:"1.3.0",request:"GetMap",LAYERS:c,TILED:!0},serverType:"geoserver"})});a[r]=u,ue(),t.addLayer(u),I(),b=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"save_custom_layers",layer_name:o,uuid:r,service_link:s,service_type:l,service_layer_name:c},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",b)}}).done(function(e){})})})},q=function(){c=$("#properties-popup"),d=$("#properties-popup-content"),u=$("#properties-popup-close-btn"),s=new ol.Overlay({element:c.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),t.addOverlay(s),u.on("click",function(){return K(),TETHYS_MAP_VIEW.clearSelection(),!1}),c.css("display","block"),TETHYS_MAP_VIEW.onSelectionChange(ie);let e=TETHYS_MAP_VIEW.getSelectInteraction();e&&e.on("select",re)},D=function(e){let t=e;e instanceof ol.geom.Point&&(t=e.getCoordinates()),s.setPosition(t)},K=function(){s.setPosition(void 0),u.blur()},Z=function(){d.empty(),K()},B=function(e){d.append(e)},re=function(e){let t=e.selected;t.length>0&&X(t)},ie=function(e,t,a){X([e,t,a])},X=function(e){let t=[];J(!1);for(var a=0;a<e.length;a++){let l=e[a],n=[];if(l&&l instanceof ol.Feature)n=[l],t.push(compute_center(n));else{if(!(l&&l.getSource()&&l.getSource().getFeatures().length))continue;n=l.getSource().getFeatures(),t.push(compute_center(n))}for(var o=0;o<n.length;o++){let e=n[o],t=Q(e);B(t);let a=ee(e);B(a);let l=P(e);B(l),A();let r=E(e);B(r),k()}}let l=compute_center(t);l&&D(l)},J=function(e=!0){e&&TETHYS_MAP_VIEW.clearSelection(),Z(),O()},Q=function(e){let t=S(e),o=a[t],l="";return'<h6 class="properites-title">'+(l=o.hasOwnProperty("tethys_data")&&o.tethys_data.hasOwnProperty("popup_title")?o.tethys_data.popup_title:o.tethys_legend_title)+"</h6>"},ee=function(e){let t=e.getProperties(),o=e.getGeometry(),l=o.getType().toLowerCase(),n="type"in t?t.type:l,r=S(e),i=a[r].tethys_data,s=["geometry","the_geom"];i.hasOwnProperty("excluded_properties")&&(s=s.concat(i.excluded_properties));let c='<tr><td>{{KEY}}</td><td>{{VALUE}}&nbsp;<span id="{{ELEMENT_CLASS}}-{{PROPERTY}}-units"></span></td></tr>';c=c.replace("{{ELEMENT_CLASS}}",n);let d='<table class="table table-condensed table-striped {{CLASS}}">{{ROWS}}</table>',u="";for(var p in s.includes("type")||(u+=c.replace("{{KEY}}","Type").replace("{{VALUE}}",o.getType()).replace("{{PROPERTY}}","type")),t){if(in_array(p,s))continue;let e=t[p];e instanceof Object?e.hasOwnProperty("type")&&e.hasOwnProperty("value")&&"dataset"==e.type?u+=te(p,e.value):console.log("WARNING: Unable to load property row - "+var_to_title_case(p)+": "+e):u+=c.replace("{{KEY}}",var_to_title_case(p)).replace("{{VALUE}}",e).replace("{{PROPERTY}}",p)}return u.length?d=(d=d.replace("{{CLASS}}",n)).replace("{{ROWS}}",u):""},te=function(e,t){let a="",o='<table class="table">',l=t.meta.columns,n=t.meta.length;a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",var_to_title_case(e));let r="";$.each(l,function(e,t){r+="<th>{{VALUE}}</th>".replace("{{VALUE}}",t)}),o+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",r);let i="";for(var s=0;s<n;s++){let e="";$.each(l,function(a,o){let l=t[o][s];e+="<td>{{VALUE}}</td>".replace("{{VALUE}}",l)}),i+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",e)}return o+=i,a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",o+="</table>")},ge=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},ae=function(){TETHYS_MAP_VIEW.overrideSelectionStyler("points",oe),TETHYS_MAP_VIEW.overrideSelectionStyler("lines",le),TETHYS_MAP_VIEW.overrideSelectionStyler("polygons",ne),n&&q()},oe=function(e,t){return[new ol.style.Style({image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#7300e5"}),stroke:new ol.style.Stroke({color:"white",width:1})})})]},le=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},ne=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6}),fill:new ol.style.Fill({color:"rgba(115, 0, 229, 0.1)"})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},pe=function(){if(f){var e=$("#map-geocode-wrapper");$(".ol-overlaycontainer-stopevent").append(e);var t=$("#geocode_select");t.select2({minimumInputLength:3,placeholder:"Search",allowClear:!0,maximumSelectionLength:1,ajax:{url:".",delay:2e3,type:"POST",data:function(e){return{method:"find-location-by-query",q:e.term,extent:l.join()}},processResults:function(e,t){return r=e.results,{results:e.results}}}}),t.on("select2:select",ye),t.on("select2:unselect",fe)}},ye=function(e){var a;if($("li.select2-search.select2-search--inline").addClass("geocode-item-selected"),is_defined(r)){for(a=0;a<r.length;a++)if(r[a].id==$(e.target).val()){var o=r[a].point,l=r[a].bbox,n=new ol.source.Vector({features:[new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(o,"EPSG:4326","EPSG:3857"))})]});if(is_defined(i))i.setSource(n);else{var s=new ol.style.Fill({color:"rgba(255,0,0,0.9)"}),c=new ol.style.Stroke({color:"rgba(255,255,255,1)",width:2}),d=new ol.style.Style({image:new ol.style.Circle({fill:s,stroke:c,radius:8}),fill:s,stroke:c});i=new ol.layer.Vector({source:n,style:d}),t.addLayer(i)}TETHYS_MAP_VIEW.zoomToExtent(l)}}else console.error("No Geocode objects defined.")},fe=function(e){if($("li.select2-search.select2-search--inline").removeClass("geocode-item-selected"),is_defined(i)){var t=i.getSource(),a=t.getFeatures();if(null!=a&&a.length>0)for(var o in a)t.removeFeature(a[o])}},function(e,t,a){e[t]=a},function(e,t){if(me(e,t))return e[t]},me=function(e,t){return t in e},function(e,t){me(e,t)&&delete e[t]},he=function(){var e=7;$(".tethys-map-view-draw-control").each(function(t,a){$(a).css("left",e+"px"),$(a).css("bottom","7px"),$(a).css("top","auto"),e+=42}),$('[data-toggle="tooltip"]').tooltip("destroy"),$('[data-toggle="tooltip"]').tooltip({placement:"top"})},e={properties_table_generator:function(e){ee=e},action_button_generator:function(e){E=e},plot_button_generator:function(e){P=e},plot_loader:function(e){C=e},action_loader:function(e){T=e},get_layer_name_from_feature:S=function(e){let t=e.get("layer_name");if(!t){let a=e.getId();t=o+":"+a.split(".")[0]}return t},get_feature_id_from_feature:w=function(e){let t=e.getId(),a="-1";return a=t?t.split(".")[1]:e.get("id")}},$(function(){g(),h(),v(),_(),I(),pe(),L(),he()}),e}();