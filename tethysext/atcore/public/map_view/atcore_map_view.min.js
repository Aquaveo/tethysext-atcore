var ATCORE_MAP_VIEW=function(){"use strict";var e,t,a,o,l,n,r,i,s,c,d,p,u,y,f,m,h,g,_,v,b,w,x,S,E,k,T,P,L,A,C,O,V,M,R,I,W,Y,N,H,j,U,F,z,G,q,D,X,J,K,Z,B,Q,ee,te,ae,oe,le,ne,re,ie,se,ce,de,pe,ue,ye,fe,me,he,ge,_e,ve,be,$e,we,xe,Se,Ee;return g=function(){var e=$("#atcore-map-attributes");e.data("layer-groups"),l=e.data("map-extent"),o=e.data("workspace"),n=e.data("enable-properties-popup")},_=function(){var e=$("#atcore-map-permissions");m=e.data("can-use-geocode"),"boolean"!=typeof(h=e.data("can-use-plot"))&&(h=!1)},v=function(){$.ajaxSetup({beforeSend:function(e,t){/^http:.*/.test(t.url)||/^https:.*/.test(t.url)||e.setRequestHeader("X-CSRFToken",get_csrf_token())}})},b=function(){$('button[title="Fit to extent"]').html('<span class="glyphicon glyphicon-home"></span>'),t=TETHYS_MAP_VIEW.getMap(),TETHYS_MAP_VIEW.zoomToExtent(l),a={},r=null,t.getLayers().forEach(function(e,t,o){"tethys_data"in e&&"layer_id"in e.tethys_data?(e.tethys_data.layer_id in a&&console.log('Warning: layer_name already in layers map: "'+e.tethys_data.layer_id+'".'),a[e.tethys_data.layer_id]=e):"tethys_legend_title"in e&&"Drawing Layer"==e.tethys_legend_title&&(r=e,a.drawing_layer=r)}),de()},x=function(){let e,t=$("#layers-tab-panel").find(".layer-group-item");$.each(t,function(t,o){if(0==(e=$("#"+o.id).find(".layer-group-visibility-control")[0].checked)){let e=$("#"+o.id).next()[0].id,t=$("#"+e).children();$.each(t,function(e,t){let o=t.getElementsByClassName("layer-visibility-control")[0].dataset.layerId;a[o].setVisible(!1)})}})},C=function(){if(!h)return;y="map-plot",f={scrollZoom:!0};I("Plot Title",[],{autosize:!0,height:415,margin:{l:80,r:80,t:20,b:80},xaxis:{title:"X Axis Title"},yaxis:{title:"Y Axis Title"}}),$(window).resize(function(){R()}),$(".toggle-nav").on("tethys:toggle-nav",function(e){R()})},I=function(e,t,a){let o=Plotly.validate(t,a);o?$(o).each(function(e,t){console.error(t.msg)}):Plotly.react(y,t,a,f).then(function(t){R(),$("#plot-slide-sheet .slide-sheet-title").html(e)})},O=function(e,t){if(!h)return;let a=k(t),o=T(e);return t&&t.hasOwnProperty("tethys_data")&&t.tethys_data.hasOwnProperty("plottable")&&t.tethys_data.plottable?'<div class="plot-btn-wrapper"><a class="btn btn-primary btn-popup btn-plot" href="javascript:void(0);" role="button"data-feature-id="'+o+'"data-layer-id="'+a+'">Plot</a></div>':void 0},P=function(e,t){if(!h)return;let a=k(t),o=T(e);return t&&t.hasOwnProperty("tethys_data")&&t.tethys_data.hasOwnProperty("has_action")&&t.tethys_data.has_action?'<div class="action-btn-wrapper"><a class="btn btn-primary btn-popup btn-action" href="javascript:void(0);" role="button"data-feature-id="'+o+'"data-layer-id="'+a+'">Action</a></div>':void 0},V=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");M(e.target,t,a),ee()})},L=function(){$(".btn-action").off("click"),$(".btn-action").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");A(e.target,t,a)})},M=function(e,t,a){$(e).attr("disabled","disabled"),$.ajax({url:".",type:"POST",data:{method:"get-plot-data",layer_name:t,feature_id:a}}).done(function(t){I(t.title,t.data,t.layout),W(),$(e).removeAttr("disabled")})},A=function(e,t,a){},R=function(){let e=$("#plot-slide-sheet").width();Plotly.relayout(y,{width:e})},W=function(){SLIDE_SHEET.open("plot-slide-sheet")},Y=function(){SLIDE_SHEET.close("plot-slide-sheet")},he=function(){$("#action-modal").on("hide.bs.modal",function(e){$("#action-modal #do-action-button").off("click")}),$("#action-modal").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()})},ge=function(e,t,a,o){let l=$("#action-modal"),n=$("#action-modal #action-modal-title"),r=$("#action-modal #action-modal-content"),i=$("#action-modal #do-action-button");return n.html(e),r.html(t),i.html(a),i.attr("class","btn btn-"+o),{modal:l,title:n,content:r,action_button:i}},_e=function(){$("#action-modal").modal("show")},ve=function(){$("#action-modal").modal("hide")},N=function(){he(),j(),U(),F(),K(),z(),G(),J(),X(),q()},H=function(e){he(),j(),U(),F(),K(),z(),G(),D(e+"--collapse")},j=function(){let e={};$('input[type="radio"]').on("click",function(){this.name in e?this!=e[this.name]?($(e[this.name]).trigger("deselect"),e[this.name]=this):(this.checked=!1,$(this).trigger("deselect"),delete e[this.name]):e[this.name]=this}).filter(":checked").each(function(){e[this.name]=this}),$(".layer-group-visibility-control").on("change",function(e){let t=$(e.target),o=t.is(":checked"),l=t.closest(".layer-group-item").next(".layer-list");le(),l.find(".layer-visibility-control").each(function(e,t){let l=$(t);l.prop("disabled",!o);let n=l.data("layer-id"),r=l.is(":checked"),i=l.data("layer-variable");a[n].setVisible(o&&r),o&&r?$("#legend-"+i).removeClass("hidden"):$("#legend-"+i).addClass("hidden")}),l.find(".layers-context-menu").each(function(e,t){let a=$(t).find(".dropdown-toggle");o?a.removeClass("disabled"):a.addClass("disabled")})}),$(".layer-visibility-control").on("change",function(e){let t=$(e.target),o=t.is(":checked"),l=t.data("layer-id"),n=t.data("layer-variable");le(),a[l].setVisible(o),o?$("#legend-"+n).removeClass("hidden"):$("#legend-"+n).addClass("hidden")}),$(".layer-visibility-control").on("deselect",function(e){let t=$(e.target),o=t.is(":checked"),l=t.data("layer-id"),n=t.data("layer-variable");a[l].setVisible(o),$("#legend-"+n).addClass("hidden")})},U=function(){$(".layer-opacity-control").on("input",function(e){let t=$(e.target),o=t.val();t.prev("label").children(".slider-value").first().html(o+"%");let l=t.data("layer-id");a[l].setOpacity(o/100)})},F=function(){$(".rename-action").on("click",function(e){let t=$(e.target);t.hasClass("rename-action")||(t=t.closest(".rename-action"));let a=t.closest(".layers-context-menu").prev().find(".display-name").first(),o=a.html(),l=ge("Rename Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" value="'+o+'" autofocus onfocus="this.select();"></div>',"Rename","success");_e(),l.action_button.on("click",function(e){let t=l.content.find("#new-name-field").first().val();a.html(t),ve()})})},z=function(){$(".remove-action").on("click",function(e){let t=$(e.target);t.hasClass("remove-action")||(t=t.closest(".remove-action"));let a=t.data("remove-type"),o=t.closest(".layers-context-menu").prev().find(".display-name").first().html(),l="",n="";"layer"===a?(l="Remove Layer",n='<p>Are you sure you want to remove the "'+o+'" layer?</p>'):(l="Remove Layer Group",n='<p>Are you sure you want to remove the "'+o+'" layer group and all of its layers?</p>');let r=ge(l,n,"Remove","danger");_e(),r.action_button.on("click",function(e){le();if("layer"===a){var o=t.data("layer-id");S(o),t.closest(".layer-list-item").remove()}else{let e=t.closest(".layer-group-item"),a=e.next(".layer-list");a.find(".layer-visibility-control").each(function(e,t){let a=$(t).data("layer-id");S(a)}),e.remove(),a.remove()}ve(),"layer"===a&&(w=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"remove_custom_layer",layer_group_type:"custom_layers",layer_id:o},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",w)}}).done(function(e){}))})})},K=function(){$(".layer-dropdown-toggle").on("switchChange.bootstrapSwitch",function(e,t){$(e.target).closest(".layers-context-menu").prev().find(".display-name").first().html()})},G=function(){$(".zoom-to-layer-action").on("click",function(e){let t=$(e.target);t.hasClass("zoom-to-layer-action")||(t=t.closest(".zoom-to-layer-action"));let o=t.data("layer-id"),n=a[o].getExtent();n?TETHYS_MAP_VIEW.zoomToExtent(n):TETHYS_MAP_VIEW.zoomToExtent(l)})},D=function(e){$("#"+e).on("click",function(e){let t=$(e.target);t.hasClass("collapse-action")||(t=t.closest(".collapse-action"));let a=t.closest(".layer-group-item").next(".layer-list");a.data("collapsed")||!1?(expand_section(a.get(0)),a.data("collapsed",!1),t.data("collapsed",!1)):(collapse_section(a.get(0)),a.data("collapsed",!0),t.data("collapsed",!0))})},q=function(){$(".collapse-action").on("click",function(e){let t=$(e.target);t.hasClass("collapse-action")||(t=t.closest(".collapse-action"));let a=t.closest(".layer-group-item").next(".layer-list");a.data("collapsed")||!1?(expand_section(a.get(0)),a.data("collapsed",!1),t.data("collapsed",!1)):(collapse_section(a.get(0)),a.data("collapsed",!0),t.data("collapsed",!0))})},J=function(){},X=function(){$(".add-layer-to-layer-group").on("click",function(e){let o=$(e.target);o.hasClass("add-layer-to-layer-group")||(o=o.closest(".add-layer-to-layer-group"));let l=o.closest(".layers-context-menu").prev(),n=(l.find(".display-name").first(),l.parent().next().first());var r=Ee();let i=ge("Add Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" style="margin-bottom:10px" value="New Layer" autofocus onfocus="this.select();"><label class="sr-only" for="service-type">Map Service Type</label><select class="form-control" style="margin-bottom:10px" id="service-type"><option value="WMS" selected>WMS</option></select><label class="sr-only" for="services-link">Service Link</label><input class="form-control" type="text" id="services-link" value="https://mrdata.usgs.gov/services/sgmc2" placeholder="Service Link (ex: https://mrdata.usgs.gov/services/sgmc2)" autofocus onfocus="this.select();"><label class="sr-only" for="service-layer-name">Layer Name</label><input class="form-control" type="text" id="service-layer-name" value="Lithology" placeholder="Layer Name (ex: Lithology)" style="margin-top: 10px" autofocus onfocus="this.select();"></div>',"Add","success");_e(),i.action_button.on("click",function(e){let o=i.content.find("#new-name-field").first().val(),l=i.content.find("#service-type").first().val(),s=i.content.find("#services-link").first().val(),c=i.content.find("#service-layer-name").first().val(),d='<li class="layer-list-item">';d+='<label class="flatmark"><span class="display-name">'+o+"</span>",d+='<input type="checkbox" class="layer-visibility-control" checked id="'+r+'"',d+='data-layer-id="'+r+'" data-layer-variable="" name="custom_layers">',d+='<span class="checkmark checkbox"></span></label>',d+='<div class="dropdown layers-context-menu pull-right">',d+='<a id="'+r+'--context-menu" class="btn btn-xs dropdown-toggle layers-btn " data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="color: rgb(186, 12, 47);">',d+='<span class="glyphicon glyphicon-option-vertical"></span></a>',d+='<ul class="dropdown-menu dropdown-menu-right" aria-labeledby="'+r+'--context-menu">',d+='<li><a class="rename-action" href="javascript:void(0);" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-pencil"></span><span class="command-name">Rename</span></a></li>',d+='<li><a class="remove-action" href="javascript:void(0);" data-remove-type="layer" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-remove"></span><span class="command-name">Remove</span></a></li>',d+='<li role="separator" class="divider"></li>',d+='<li><a class="zoom-to-layer-action" href="javascript:void(0);" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-fullscreen"></span><span class="command-name">Zoom to Layer</span></a></li>',d+='<li role="separator" class="divider"></li>',d+="<li>",d+='<div class="flat-slider-container">',d+='<label><span class="glyphicon glyphicon-adjust"></span><span class="command-name">Opacity: </span><span class="slider-value">100%</span></label>',d+='<div class="flat-slider-container">',d+='<input type="range" class="flat-slider layer-opacity-control" min="0" max="100" value="100" data-layer-id="'+r+'" data-layer-variable="">',d+="</div>",d+="</li></ul>",n.append(d),n.css({overflow:"visible"});var p=new ol.layer.Tile({source:new ol.source.TileWMS({url:s,params:{service:l,version:"1.3.0",request:"GetMap",LAYERS:c,TILED:!0},serverType:"geoserver"})});a[r]=p,ve(),t.addLayer(p),H(r),w=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"save_custom_layers",layer_name:o,uuid:r,service_link:s,service_type:l,service_layer_name:c},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",w)}}).done(function(e){})})})},Z=function(){d=$("#properties-popup"),p=$("#properties-popup-content"),u=$("#properties-popup-close-btn"),c=new ol.Overlay({element:d.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),t.addOverlay(c),u.on("click",function(){return te(),!1}),d.css("display","block"),TETHYS_MAP_VIEW.onSelectionChange(me);let e=TETHYS_MAP_VIEW.getSelectInteraction();e&&e.on("select",fe)},Q=function(e){let t=e;e instanceof ol.geom.Point&&(t=e.getCoordinates()),d.trigger("show.atcore.popup"),c.setPosition(t),d.trigger("shown.atcore.popup")},te=function(){d.trigger("closing.atcore.popup"),ee(),TETHYS_MAP_VIEW.clearSelection(),d.trigger("closed.atcore.popup")},ae=function(){p.empty(),ee()},oe=function(e){p.append(e)},fe=function(e){let t=e.selected;t.length>0&&B(t)},me=function(e,t,a){B([e,t,a])},B=function(e){let t=[];le(!1);for(var o=0;o<e.length;o++){let n=e[o],r=[];if(n&&n instanceof ol.Feature)r=[n],t.push(compute_center(r));else{if(!(n&&n.getSource()&&n.getSource().getFeatures().length))continue;r=n.getSource().getFeatures(),t.push(compute_center(r))}for(var l=0;l<r.length;l++){let e=r[l],t=E(e),o=a[t],n=ne(e,o);oe(n);let i=re(e,o);oe(i);let s=se(e,o);oe(s),ce();let c=O(e,o);oe(c),V();let d=P(e,o);oe(d),L()}}let n=compute_center(t);n&&Q(n)},le=function(e=!0){e&&TETHYS_MAP_VIEW.clearSelection(),n&&ae(),Y()},ne=function(e,t){let a="";return'<h6 class="properites-title">'+(a=t.hasOwnProperty("tethys_data")&&t.tethys_data.hasOwnProperty("popup_title")?t.tethys_data.popup_title:t.tethys_legend_title)+"</h6>"},re=function(e,t){let a=e.getProperties(),o=e.getGeometry(),l=o.getType().toLowerCase(),n="type"in a?a.type:l,r=t.tethys_data||{},i=["geometry","the_geom"];r.hasOwnProperty("excluded_properties")&&(i=i.concat(r.excluded_properties));let s='<tr><td>{{KEY}}</td><td>{{VALUE}}&nbsp;<span id="{{ELEMENT_CLASS}}-{{PROPERTY}}-units"></span></td></tr>';s=s.replace("{{ELEMENT_CLASS}}",n);let c='<table class="table table-condensed table-striped {{CLASS}}">{{ROWS}}</table>',d="";for(var p in i.includes("type")||(d+=s.replace("{{KEY}}","Type").replace("{{VALUE}}",o.getType()).replace("{{PROPERTY}}","type")),a){if(in_array(p,i))continue;let e=a[p];e instanceof Object?e.hasOwnProperty("type")&&e.hasOwnProperty("value")&&"dataset"==e.type?d+=ie(p,e.value):console.log("WARNING: Unable to load property row - "+var_to_title_case(p)+": "+e):d+=s.replace("{{KEY}}",var_to_title_case(p)).replace("{{VALUE}}",e).replace("{{PROPERTY}}",p)}return d.length?c=(c=c.replace("{{CLASS}}",n)).replace("{{ROWS}}",d):""},ie=function(e,t){let a="",o='<table class="table">',l=t.meta.columns,n=t.meta.length;a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",var_to_title_case(e));let r="";$.each(l,function(e,t){r+="<th>{{VALUE}}</th>".replace("{{VALUE}}",t)}),o+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",r);let i="";for(var s=0;s<n;s++){let e="";$.each(l,function(a,o){let l=t[o][s];e+="<td>{{VALUE}}</td>".replace("{{VALUE}}",l)}),i+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",e)}return o+=i,a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",o+="</table>")},se=function(e,t){return""},ce=function(){},Ee=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},de=function(){TETHYS_MAP_VIEW.overrideSelectionStyler("points",pe),TETHYS_MAP_VIEW.overrideSelectionStyler("lines",ue),TETHYS_MAP_VIEW.overrideSelectionStyler("polygons",ye),n&&Z()},pe=function(e,t){return[new ol.style.Style({image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#7300e5"}),stroke:new ol.style.Stroke({color:"white",width:1})})})]},ue=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},ye=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6}),fill:new ol.style.Fill({color:"rgba(115, 0, 229, 0.1)"})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},be=function(){if(m){var e=$("#map-geocode-wrapper");$(".ol-overlaycontainer-stopevent").append(e);var t=$("#geocode_select");t.select2({minimumInputLength:3,placeholder:"Search",allowClear:!0,maximumSelectionLength:1,ajax:{url:".",delay:2e3,type:"POST",data:function(e){return{method:"find-location-by-query",q:e.term,extent:l.join()}},processResults:function(e,t){return i=e.results,{results:e.results}}}}),t.on("select2:select",$e),t.on("select2:unselect",we)}},$e=function(e){var a;if($("li.select2-search.select2-search--inline").addClass("geocode-item-selected"),is_defined(i)){for(a=0;a<i.length;a++)if(i[a].id==$(e.target).val()){var o=i[a].point,l=i[a].bbox,n=new ol.source.Vector({features:[new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(o,"EPSG:4326","EPSG:3857"))})]});if(is_defined(s))s.setSource(n);else{var r=new ol.style.Fill({color:"rgba(255,0,0,0.9)"}),c=new ol.style.Stroke({color:"rgba(255,255,255,1)",width:2}),d=new ol.style.Style({image:new ol.style.Circle({fill:r,stroke:c,radius:8}),fill:r,stroke:c});s=new ol.layer.Vector({source:n,style:d}),t.addLayer(s)}TETHYS_MAP_VIEW.zoomToExtent(l)}}else console.error("No Geocode objects defined.")},we=function(e){if($("li.select2-search.select2-search--inline").removeClass("geocode-item-selected"),is_defined(s)){var t=s.getSource(),a=t.getFeatures();if(null!=a&&a.length>0)for(var o in a)t.removeFeature(a[o])}},function(e,t,a){e[t]=a},function(e,t){if(xe(e,t))return e[t]},xe=function(e,t){return t in e},function(e,t){xe(e,t)&&delete e[t]},Se=function(){var e=7;$(".tethys-map-view-draw-control").each(function(t,a){$(a).css("left",e+"px"),$(a).css("bottom","7px"),$(a).css("top","auto"),e+=42}),$('[data-toggle="tooltip"]').tooltip("destroy"),$('[data-toggle="tooltip"]').tooltip({placement:"top"})},e={properties_table_generator:function(e){re=e},custom_properties_generator:function(e){se=e},custom_properties_initializer:function(e){ce=e},action_button_generator:function(e){P=e},plot_button_generator:function(e){O=e},plot_loader:function(e){M=e},action_loader:function(e){A=e},get_layer_name_from_feature:E=function(e){let t=e.get("layer_name");if(!t){"drawing_layer"!==(t=(e.getId()||e.get("id")).split(".")[0])&&(t=o+":"+t)}return t},get_layer_id_from_layer:k=function(e){return e&&e.hasOwnProperty("tethys_data")&&e.tethys_data?e.tethys_data.hasOwnProperty("layer_id")?e.tethys_data.layer_id:e.tethys_data.hasOwnProperty("layer_name")?e.tethys_data.layer_name:"":""},get_feature_id_from_feature:T=function(e){let t=e.getId(),a="-1";return a=t?t.split(".")[1]:e.get("id")},hide_properties_pop_up:ee=function(){d.trigger("hide.atcore.popup"),c.setPosition(void 0),u.blur(),d.trigger("hidden.atcore.popup")},reset_properties_pop_up:ae,close_properties_pop_up:te,load_layers:function(e,o,l,n,r,i){var s=0;for(s=0;s<l.length;s++)a[r[s]]=l[s],t.addLayer(l[s]);var c="create";$("#"+o).length&&(c="append"),$.ajax({type:"POST",url:".",async:!1,data:{method:"build_layer_group_tree_item",status:c,layer_group_id:o,layer_group_name:e,layer_names:JSON.stringify(n),layer_ids:JSON.stringify(r),layer_legends:JSON.stringify(i)}}).done(function(e){"create"==c?$("#layers-tab-panel").prepend(e.response):$("#"+o+"_associated_layers").prepend(e.response)}),H(o)},hide_layers:function(e){for(var t=0;t<e.length;t++)a[e[t]].setVisible(!1),$('[data-layer-id="'+e[t]+'"]').first().closest("li").addClass("hidden")},show_layers:function(e){for(var t=0;t<e.length;t++)$('[data-layer-id="'+e[t]+'"]').first().closest("li").removeClass("hidden")},remove_layer_from_map:S=function(e){t.removeLayer(a[e]),delete a[e]},init_layers_tab:N},$(function(){_(),g(),v(),b(),N(),be(),C(),Se(),x()}),e}();