var ATCORE_MAP_VIEW=function(){"use strict";var a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta;return s=function(){var a=$("#atcore-map-attributes");d=a.data("layer-groups"),f=a.data("map-extent"),e=a.data("workspace"),g=a.data("enable-properties-popup")},t=function(){var a=$("#atcore-map-permissions");q=a.data("can-use-geocode"),r=a.data("can-use-plot")},u=function(){$.ajaxSetup({beforeSend:function(a,b){/^http:.*/.test(b.url)||/^https:.*/.test(b.url)||a.setRequestHeader("X-CSRFToken",get_csrf_token())}})},v=function(){let a=$("button[title=\"Fit to extent\"]");a.html("<span class=\"glyphicon glyphicon-home\"></span>"),b=TETHYS_MAP_VIEW.getMap(),TETHYS_MAP_VIEW.zoomToExtent(f),c={},b.getLayers().forEach(function(a){"tethys_data"in a&&"layer_name"in a.tethys_data&&(a.tethys_data.layer_name in c&&console.log("Warning: layer_name already in layers map: \""+a.tethys_data.layer_name+"\"."),c[a.tethys_data.layer_name]=a)}),ca()},w=function(a){b.removeLayer(c[a]),delete c[a]},x=function(a){let b=a.get("layer_name");if(!b){let c=a.getId();b=e+":"+c.split(".")[0]}return b},y=function(a){let b=a.getId(),c="-1";return c=b?b.split(".")[1]:a.get("id"),c},C=function(){if(!r)return;o="map-plot",p={scrollZoom:!0};H("Plot Title",[],{autosize:!0,height:415,margin:{l:80,r:80,t:20,b:80},xaxis:{title:"X Axis Title"},yaxis:{title:"Y Axis Title"}}),$(window).resize(function(){G()}),$(".toggle-nav").on("tethys:toggle-nav",function(){G()})},H=function(a,b,c){let d=Plotly.validate(b,c);return d?void $(d).each(function(a,b){console.error(b.msg)}):void Plotly.react(o,b,c,p).then(function(){G(),$("#plot-slide-sheet .slide-sheet-title").html(a)})},D=function(a){if(!r)return;let b=x(a),d=y(a),e=c[b];if(e&&e.tethys_data.plottable){return"<div class=\"plot-btn-wrapper\"><a class=\"btn btn-primary btn-popup\" href=\"javascript:void(0);\" role=\"button\"data-feature-id=\""+d+"\"data-layer-id=\""+b+"\">Plot</a></div>"}},z=function(a){if(!r)return;let b=x(a),d=y(a),e=c[b];if(e&&e.tethys_data.has_action){return"<div class=\"action-btn-wrapper\"><a class=\"btn btn-primary btn-popup\" href=\"javascript:void(0);\" role=\"button\"data-feature-id=\""+d+"\"data-layer-id=\""+b+"\">Action</a></div>"}},E=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(a){let b=$(a.target).data("layer-name"),c=$(a.target).data("feature-id");F(a.target,b,c)})},A=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(a){let b=$(a.target).data("layer-name"),c=$(a.target).data("feature-id");B(a.target,b,c)})},F=function(a,b,c){$(a).attr("disabled","disabled"),$.ajax({url:".",type:"POST",data:{method:"get-plot-data",layer_name:b,feature_id:c}}).done(function(b){H(b.title,b.data,b.layout),I(),$(a).removeAttr("disabled")})},B=function(){},G=function(){let a=$("#plot-slide-sheet").width();Plotly.relayout(o,{width:a})},I=function(){SLIDE_SHEET.open("plot-slide-sheet")},J=function(){SLIDE_SHEET.close("plot-slide-sheet")},ia=function(){$("#action-modal").on("hide.bs.modal",function(){let a=$("#action-modal #do-action-button");a.off("click")}),$("#action-modal").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()})},ja=function(a,b,c,d){let e=$("#action-modal"),f=$("#action-modal #action-modal-title"),g=$("#action-modal #action-modal-content"),h=$("#action-modal #do-action-button");return f.html(a),g.html(b),h.html(c),h.attr("class","btn btn-"+d),{modal:e,title:f,content:g,action_button:h}},ka=function(){let a=$("#action-modal");a.modal("show")},la=function(){let a=$("#action-modal");a.modal("hide")},K=function(){ia(),L(),M(),N(),O(),P(),S(),R(),Q()},L=function(){let a={};$("input[type=\"radio\"]").on("click",function(){this.name in a?this==a[this.name]?(this.checked=!1,$(this).trigger("deselect"),delete a[this.name]):($(a[this.name]).trigger("deselect"),a[this.name]=this):a[this.name]=this}).filter(":checked").each(function(){a[this.name]=this}),$(".layer-group-visibility-control").on("change",function(a){let b=$(a.target),d=b.is(":checked"),e=b.closest(".layer-group-item"),f=e.next(".layer-list");Z();let g=f.find(".layer-visibility-control");g.each(function(a,b){let e=$(b);e.prop("disabled",!d);let f=e.data("layer-name"),g=e.is(":checked"),h=e.data("layer-variable");c[f].setVisible(d&&g),d&&g?$("#legend-"+h).removeClass("hidden"):$("#legend-"+h).addClass("hidden")});let h=f.find(".layers-context-menu");h.each(function(a,b){let c=$(b).find(".dropdown-toggle");d?c.removeClass("disabled"):c.addClass("disabled")})}),$(".layer-visibility-control").on("change",function(a){let b=$(a.target),d=b.is(":checked"),e=b.data("layer-name"),f=b.data("layer-variable");Z(),c[e].setVisible(d),$("#legend-"+f).removeClass("hidden")}),$(".layer-visibility-control").on("deselect",function(a){let b=$(a.target),d=b.is(":checked"),e=b.data("layer-name"),f=b.data("layer-variable");c[e].setVisible(d),$("#legend-"+f).addClass("hidden")})},M=function(){$(".layer-opacity-control").on("input",function(a){let b=$(a.target),d=b.val(),e=b.prev("label"),f=e.children(".slider-value").first();f.html(d+"%");let g=b.data("layer-name");c[g].setOpacity(d/100)})},N=function(){$(".rename-action").on("click",function(a){let b=$(a.target);b.hasClass("rename-action")||(b=b.closest(".rename-action"));let c=b.closest(".layers-context-menu").prev(),d=c.find(".display-name").first(),e=d.html(),f=ja("Rename Layer","<div class=\"form-group\"><label class=\"sr-only\" for=\"new-name-field\">New name:</label><input class=\"form-control\" type=\"text\" id=\"new-name-field\" value=\""+e+"\" autofocus onfocus=\"this.select();\"></div>","Rename","success");ka(),f.action_button.on("click",function(){let a=f.content.find("#new-name-field").first().val();d.html(a),la()})})},O=function(){$(".remove-action").on("click",function(a){let b=$(a.target);b.hasClass("remove-action")||(b=b.closest(".remove-action"));let c=b.data("remove-type"),d=b.closest(".layers-context-menu").prev(),e=d.find(".display-name").first().html(),f="",g="";"layer"===c?(f="Remove Layer",g="<p>Are you sure you want to remove the \""+e+"\" layer?</p>"):(f="Remove Layer Group",g="<p>Are you sure you want to remove the \""+e+"\" layer group and all of its layers?</p>");let h=ja(f,g,"Remove","danger");ka(),h.action_button.on("click",function(){if(Z(),"layer"===c){let a=b.data("layer-name");w(a);let c=b.closest(".layer-list-item");c.remove()}else{let a=b.closest(".layer-group-item"),c=a.next(".layer-list"),d=c.find(".layer-visibility-control");d.each(function(a,b){let c=$(b).data("layer-name");w(c)}),a.remove(),c.remove()}la()})})},P=function(){$(".zoom-to-layer-action").on("click",function(a){let b=$(a.target);b.hasClass("zoom-to-layer-action")||(b=b.closest(".zoom-to-layer-action"));let d=b.data("layer-name"),e=c[d].getExtent();e?TETHYS_MAP_VIEW.zoomToExtent(e):TETHYS_MAP_VIEW.zoomToExtent(f)})},Q=function(){$(".collapse-action").on("click",function(a){let b=$(a.target);b.hasClass("collapse-action")||(b=b.closest(".collapse-action"));let c=b.closest(".layer-group-item"),d=c.next(".layer-list"),e=d.data("collapsed")||!1;e?(expand_section(d.get(0)),d.data("collapsed",!1),b.data("collapsed",!1)):(collapse_section(d.get(0)),d.data("collapsed",!0),b.data("collapsed",!0))})},S=function(){},R=function(){},T=function(){l=$("#properties-popup"),m=$("#properties-popup-content"),n=$("#properties-popup-close-btn"),k=new ol.Overlay({element:l.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),b.addOverlay(k),n.on("click",function(){return W(),TETHYS_MAP_VIEW.clearSelection(),!1}),l.css("display","block"),TETHYS_MAP_VIEW.onSelectionChange(ha);let a=TETHYS_MAP_VIEW.getSelectInteraction();a&&a.on("select",ga)},V=function(a){let b=a;a instanceof ol.geom.Point&&(b=a.getCoordinates()),k.setPosition(b)},W=function(){k.setPosition(void 0),n.blur()},X=function(){m.empty(),W()},Y=function(a){m.append(a)},ga=function(a){let b=a.selected;0<b.length&&U(b)},ha=function(a,b,c){U([a,b,c])},U=function(a){let b=[];Z(!1);for(var c=0;c<a.length;c++){let e=a[c],f=[];if(e&&e instanceof ol.Feature)f=[e],b.push(compute_center(f));else if(e&&e.getSource()&&e.getSource().getFeatures().length){let a=e.getSource();f=a.getFeatures(),b.push(compute_center(f))}else continue;for(var d=0;d<f.length;d++){let a=f[d],b=_(a);Y(b);let c=aa(a);Y(c);let e=D(a);Y(e),E();let g=z(a);Y(g),A()}}let e=compute_center(b);e&&V(e)},Z=function(a=!0){a&&TETHYS_MAP_VIEW.clearSelection(),X(),J()},_=function(a){let b=x(a),d=c[b],e="";e=d.hasOwnProperty("tethys_data")&&d.tethys_data.hasOwnProperty("popup_title")?d.tethys_data.popup_title:d.tethys_legend_title;let f="<h6 class=\"properites-title\">"+e+"</h6>";return f},aa=function(a){let b=a.getProperties(),d=a.getGeometry(),e=d.getType().toLowerCase(),f="type"in b?b.type:e,g=x(a),h=c[g].tethys_data,i=["geometry","the_geom"];h.hasOwnProperty("excluded_properties")&&(i=i.concat(h.excluded_properties));let j="<tr><td>{{KEY}}</td><td>{{VALUE}}&nbsp;<span id=\"{{ELEMENT_CLASS}}-{{PROPERTY}}-units\"></span></td></tr>";j=j.replace("{{ELEMENT_CLASS}}",f);let k="<table class=\"table table-condensed table-striped {{CLASS}}\">{{ROWS}}</table>",l="";for(var m in i.includes("type")||(l+=j.replace("{{KEY}}","Type").replace("{{VALUE}}",d.getType()).replace("{{PROPERTY}}","type")),b){if(in_array(m,i))continue;let a=b[m];a instanceof Object?a.hasOwnProperty("type")&&a.hasOwnProperty("value")&&"dataset"==a.type?l+=ba(m,a.value):console.log("WARNING: Unable to load property row - "+var_to_title_case(m)+": "+a):l+=j.replace("{{KEY}}",var_to_title_case(m)).replace("{{VALUE}}",a).replace("{{PROPERTY}}",m)}return l.length?(k=k.replace("{{CLASS}}",f),k=k.replace("{{ROWS}}",l),k):""},ba=function(a,b){let c="",d="<table class=\"table\">",e="<tr>{{COLUMNS}}</tr>",f=b.meta.columns,g=b.meta.length;c+="<tr><td colspan=\"2\">{{VALUE}}</td></tr>".replace("{{VALUE}}",var_to_title_case(a));let h="";$.each(f,function(a,b){h+="<th>{{VALUE}}</th>".replace("{{VALUE}}",b)}),d+=e.replace("{{COLUMNS}}",h);let j="";for(var k=0;k<g;k++){let a="";$.each(f,function(c,d){let e=b[d][k];a+="<td>{{VALUE}}</td>".replace("{{VALUE}}",e)}),j+=e.replace("{{COLUMNS}}",a)}return d+=j,d+="</table>",c+="<tr><td colspan=\"2\">{{VALUE}}</td></tr>".replace("{{VALUE}}",d),c},ca=function(){TETHYS_MAP_VIEW.overrideSelectionStyler("points",da),TETHYS_MAP_VIEW.overrideSelectionStyler("lines",ea),TETHYS_MAP_VIEW.overrideSelectionStyler("polygons",fa),g&&T()},da=function(){return[new ol.style.Style({image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#7300e5"}),stroke:new ol.style.Stroke({color:"white",width:1})})})]},ea=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},fa=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6}),fill:new ol.style.Fill({color:"rgba(115, 0, 229, 0.1)"})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},ma=function(){if(q){var a=$("#map-geocode-wrapper"),b=$(".ol-overlaycontainer-stopevent");b.append(a);var c=$("#geocode_select");c.select2({minimumInputLength:3,placeholder:"Search",allowClear:!0,maximumSelectionLength:1,ajax:{url:".",delay:2e3,type:"POST",data:function(a){return{method:"find-location-by-query",q:a.term,extent:f.join()}},processResults:function(a){return h=a.results,{results:a.results}}}}),c.on("select2:select",na),c.on("select2:unselect",oa)}},na=function(a){var c,d=$("li.select2-search.select2-search--inline");if(d.addClass("geocode-item-selected"),is_defined(h)){for(c=0;c<h.length;c++)if(h[c].id==$(a.target).val()){var e=h[c].point,f=h[c].bbox,g=new ol.source.Vector({features:[new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))})]});if(is_defined(j))j.setSource(g);else{var k=new ol.style.Fill({color:"rgba(255,0,0,0.9)"}),l=new ol.style.Stroke({color:"rgba(255,255,255,1)",width:2}),m=new ol.style.Style({image:new ol.style.Circle({fill:k,stroke:l,radius:8}),fill:k,stroke:l});j=new ol.layer.Vector({source:g,style:m}),b.addLayer(j)}TETHYS_MAP_VIEW.zoomToExtent(f)}}else console.error("No Geocode objects defined.")},oa=function(){var a=$("li.select2-search.select2-search--inline");if(a.removeClass("geocode-item-selected"),is_defined(j)){var b=j.getSource(),c=b.getFeatures();if(null!=c&&0<c.length)for(var d in c)b.removeFeature(c[d])}},qa=function(a,b,c){a[b]=c},sa=function(a,b){if(pa(a,b))return a[b]},pa=function(a,b){return!!(b in a)},ra=function(a,b){pa(a,b)&&delete a[b]},ta=function(){var a=7;$(".tethys-map-view-draw-control").each(function(b,c){$(c).css("left",a+"px"),$(c).css("bottom","7px"),$(c).css("top","auto"),a+=42}),$("[data-toggle=\"tooltip\"]").tooltip("destroy"),$("[data-toggle=\"tooltip\"]").tooltip({placement:"top"})},a={properties_table_generator:function(a){aa=a},action_button_generator:function(a){z=a},plot_button_generator:function(a){D=a},plot_loader:function(a){F=a},action_loader:function(a){B=a},get_layer_name_from_feature:x,get_feature_id_from_feature:y},$(function(){t(),s(),u(),v(),K(),ma(),C(),ta()}),a}();