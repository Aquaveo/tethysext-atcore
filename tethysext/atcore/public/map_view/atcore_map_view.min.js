var ATCORE_MAP_VIEW=function(){"use strict";var e,t,a,l,o,n,r,i,s,c,d,p,u,y,f,m,h,g,v,_,b,x,S,w,E,k,T,L,P,A,C,V,O,M,R,I,W,Y,N,H,j,U,F,z,G,q,X,D,J,K,Z,B,Q,ee,te,ae,le,oe,ne,re,ie,se,ce,de,pe,ue,ye,fe,me,he,ge,ve;return h=function(){var e=$("#atcore-map-attributes");e.data("layer-groups"),o=e.data("map-extent"),l=e.data("workspace"),n=e.data("enable-properties-popup")},g=function(){var e=$("#atcore-map-permissions");f=e.data("can-use-geocode"),"boolean"!=typeof(m=e.data("can-use-plot"))&&(m=!1)},v=function(){$.ajaxSetup({beforeSend:function(e,t){/^http:.*/.test(t.url)||/^https:.*/.test(t.url)||e.setRequestHeader("X-CSRFToken",get_csrf_token())}})},_=function(){$('button[title="Fit to extent"]').html('<span class="glyphicon glyphicon-home"></span>'),t=TETHYS_MAP_VIEW.getMap(),TETHYS_MAP_VIEW.zoomToExtent(o),a={},t.getLayers().forEach(function(e,t,l){"tethys_data"in e&&"layer_id"in e.tethys_data&&(e.tethys_data.layer_id in a&&console.log('Warning: layer_name already in layers map: "'+e.tethys_data.layer_id+'".'),a[e.tethys_data.layer_id]=e)}),le()},x=function(){let e,t=$("#layers-tab-panel").find(".layer-group-item");$.each(t,function(t,l){if(0==(e=$("#"+l.id).find(".layer-group-visibility-control")[0].checked)){let e=$("#"+l.id).next()[0].id,t=$("#"+e).children();$.each(t,function(e,t){let l=t.getElementsByClassName("layer-visibility-control")[0].dataset.layerId;a[l].setVisible(!1)})}})},P=function(){if(!m)return;u="map-plot",y={scrollZoom:!0};M("Plot Title",[],{autosize:!0,height:415,margin:{l:80,r:80,t:20,b:80},xaxis:{title:"X Axis Title"},yaxis:{title:"Y Axis Title"}}),$(window).resize(function(){O()}),$(".toggle-nav").on("tethys:toggle-nav",function(e){O()})},M=function(e,t,a){let l=Plotly.validate(t,a);l?$(l).each(function(e,t){console.error(t.msg)}):Plotly.react(u,t,a,y).then(function(t){O(),$("#plot-slide-sheet .slide-sheet-title").html(e)})},A=function(e){if(!m)return;let t=w(e),l=E(e),o=a[t];return o&&o.tethys_data.plottable?'<div class="plot-btn-wrapper"><a class="btn btn-primary btn-popup btn-plot" href="javascript:void(0);" role="button"data-feature-id="'+l+'"data-layer-id="'+t+'">Plot</a></div>':void 0},k=function(e){if(!m)return;let t=w(e),l=E(e),o=a[t];return o&&o.tethys_data.has_action?'<div class="action-btn-wrapper"><a class="btn btn-primary btn-popup btn-action" href="javascript:void(0);" role="button"data-feature-id="'+l+'"data-layer-id="'+t+'">Action</a></div>':void 0},C=function(){$(".btn-plot").off("click"),$(".btn-plot").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");V(e.target,t,a),K()})},T=function(){$(".btn-action").off("click"),$(".btn-action").on("click",function(e){let t=$(e.target).data("layer-id"),a=$(e.target).data("feature-id");L(e.target,t,a)})},V=function(e,t,a){$(e).attr("disabled","disabled"),$.ajax({url:".",type:"POST",data:{method:"get-plot-data",layer_name:t,feature_id:a}}).done(function(t){M(t.title,t.data,t.layout),R(),$(e).removeAttr("disabled")})},L=function(e,t,a){},O=function(){let e=$("#plot-slide-sheet").width();Plotly.relayout(u,{width:e})},R=function(){SLIDE_SHEET.open("plot-slide-sheet")},I=function(){SLIDE_SHEET.close("plot-slide-sheet")},ce=function(){$("#action-modal").on("hide.bs.modal",function(e){$("#action-modal #do-action-button").off("click")}),$("#action-modal").on("shown.bs.modal",function(){$(this).find("[autofocus]").focus()})},de=function(e,t,a,l){let o=$("#action-modal"),n=$("#action-modal #action-modal-title"),r=$("#action-modal #action-modal-content"),i=$("#action-modal #do-action-button");return n.html(e),r.html(t),i.html(a),i.attr("class","btn btn-"+l),{modal:o,title:n,content:r,action_button:i}},pe=function(){$("#action-modal").modal("show")},ue=function(){$("#action-modal").modal("hide")},W=function(){ce(),Y(),N(),H(),q(),j(),U(),G(),z(),F()},Y=function(){let e={};$('input[type="radio"]').on("click",function(){this.name in e?this!=e[this.name]?($(e[this.name]).trigger("deselect"),e[this.name]=this):(this.checked=!1,$(this).trigger("deselect"),delete e[this.name]):e[this.name]=this}).filter(":checked").each(function(){e[this.name]=this}),$(".layer-group-visibility-control").on("change",function(e){let t=$(e.target),l=t.is(":checked"),o=t.closest(".layer-group-item").next(".layer-list");Q(),o.find(".layer-visibility-control").each(function(e,t){let o=$(t);o.prop("disabled",!l);let n=o.data("layer-id"),r=o.is(":checked"),i=o.data("layer-variable");a[n].setVisible(l&&r),l&&r?$("#legend-"+i).removeClass("hidden"):$("#legend-"+i).addClass("hidden")}),o.find(".layers-context-menu").each(function(e,t){let a=$(t).find(".dropdown-toggle");l?a.removeClass("disabled"):a.addClass("disabled")})}),$(".layer-visibility-control").on("change",function(e){let t=$(e.target),l=t.is(":checked"),o=t.data("layer-id"),n=t.data("layer-variable");Q(),a[o].setVisible(l),l?$("#legend-"+n).removeClass("hidden"):$("#legend-"+n).addClass("hidden")}),$(".layer-visibility-control").on("deselect",function(e){let t=$(e.target),l=t.is(":checked"),o=t.data("layer-id"),n=t.data("layer-variable");a[o].setVisible(l),$("#legend-"+n).addClass("hidden")})},N=function(){$(".layer-opacity-control").on("input",function(e){let t=$(e.target),l=t.val();t.prev("label").children(".slider-value").first().html(l+"%");let o=t.data("layer-id");a[o].setOpacity(l/100)})},H=function(){$(".rename-action").on("click",function(e){let t=$(e.target);t.hasClass("rename-action")||(t=t.closest(".rename-action"));let a=t.closest(".layers-context-menu").prev().find(".display-name").first(),l=a.html(),o=de("Rename Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" value="'+l+'" autofocus onfocus="this.select();"></div>',"Rename","success");pe(),o.action_button.on("click",function(e){let t=o.content.find("#new-name-field").first().val();a.html(t),ue()})})},j=function(){$(".remove-action").on("click",function(e){let t=$(e.target);t.hasClass("remove-action")||(t=t.closest(".remove-action"));let a=t.data("remove-type"),l=t.closest(".layers-context-menu").prev().find(".display-name").first().html(),o="",n="";"layer"===a?(o="Remove Layer",n='<p>Are you sure you want to remove the "'+l+'" layer?</p>'):(o="Remove Layer Group",n='<p>Are you sure you want to remove the "'+l+'" layer group and all of its layers?</p>');let r=de(o,n,"Remove","danger");pe(),r.action_button.on("click",function(e){Q();if("layer"===a){var l=t.data("layer-id");S(l),t.closest(".layer-list-item").remove()}else{let e=t.closest(".layer-group-item"),a=e.next(".layer-list");a.find(".layer-visibility-control").each(function(e,t){let a=$(t).data("layer-id");S(a)}),e.remove(),a.remove()}ue(),"layer"===a&&(b=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"remove_custom_layer",layer_group_type:"custom_layers",layer_id:l},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",b)}}).done(function(e){}))})})},q=function(){$(".layer-dropdown-toggle").on("switchChange.bootstrapSwitch",function(e,t){$(e.target).closest(".layers-context-menu").prev().find(".display-name").first().html()})},U=function(){$(".zoom-to-layer-action").on("click",function(e){let t=$(e.target);t.hasClass("zoom-to-layer-action")||(t=t.closest(".zoom-to-layer-action"));let l=t.data("layer-id"),n=a[l].getExtent();n?TETHYS_MAP_VIEW.zoomToExtent(n):TETHYS_MAP_VIEW.zoomToExtent(o)})},F=function(){$(".collapse-action").on("click",function(e){let t=$(e.target);t.hasClass("collapse-action")||(t=t.closest(".collapse-action"));let a=t.closest(".layer-group-item").next(".layer-list");a.data("collapsed")||!1?(expand_section(a.get(0)),a.data("collapsed",!1),t.data("collapsed",!1)):(collapse_section(a.get(0)),a.data("collapsed",!0),t.data("collapsed",!0))})},G=function(){},z=function(){$(".add-layer-to-layer-group").on("click",function(e){let l=$(e.target);l.hasClass("add-layer-to-layer-group")||(l=l.closest(".add-layer-to-layer-group"));let o=l.closest(".layers-context-menu").prev(),n=(o.find(".display-name").first(),o.parent().next().first());var r=ve();let i=de("Add Layer",'<div class="form-group"><label class="sr-only" for="new-name-field">New name:</label><input class="form-control" type="text" id="new-name-field" style="margin-bottom:10px" value="New Layer" autofocus onfocus="this.select();"><label class="sr-only" for="service-type">Map Service Type</label><select class="form-control" style="margin-bottom:10px" id="service-type"><option value="WMS" selected>WMS</option></select><label class="sr-only" for="services-link">Service Link</label><input class="form-control" type="text" id="services-link" value="https://mrdata.usgs.gov/services/sgmc2" placeholder="Service Link (ex: https://mrdata.usgs.gov/services/sgmc2)" autofocus onfocus="this.select();"><label class="sr-only" for="service-layer-name">Layer Name</label><input class="form-control" type="text" id="service-layer-name" value="Lithology" placeholder="Layer Name (ex: Lithology)" style="margin-top: 10px" autofocus onfocus="this.select();"></div>',"Add","success");pe(),i.action_button.on("click",function(e){let l=i.content.find("#new-name-field").first().val(),o=i.content.find("#service-type").first().val(),s=i.content.find("#services-link").first().val(),c=i.content.find("#service-layer-name").first().val(),d='<li class="layer-list-item">';d+='<label class="flatmark"><span class="display-name">'+l+"</span>",d+='<input type="checkbox" class="layer-visibility-control" checked id="'+r+'"',d+='data-layer-id="'+r+'" data-layer-variable="" name="custom_layers">',d+='<span class="checkmark checkbox"></span></label>',d+='<div class="dropdown layers-context-menu pull-right">',d+='<a id="'+r+'--context-menu" class="btn btn-xs dropdown-toggle layers-btn " data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="color: rgb(186, 12, 47);">',d+='<span class="glyphicon glyphicon-option-vertical"></span></a>',d+='<ul class="dropdown-menu dropdown-menu-right" aria-labeledby="'+r+'--context-menu">',d+='<li><a class="rename-action" href="javascript:void(0);" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-pencil"></span><span class="command-name">Rename</span></a></li>',d+='<li><a class="remove-action" href="javascript:void(0);" data-remove-type="layer" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-remove"></span><span class="command-name">Remove</span></a></li>',d+='<li role="separator" class="divider"></li>',d+='<li><a class="zoom-to-layer-action" href="javascript:void(0);" data-layer-id="'+r+'" style="color: rgb(186, 12, 47);"><span class="glyphicon glyphicon-fullscreen"></span><span class="command-name">Zoom to Layer</span></a></li>',d+='<li role="separator" class="divider"></li>',d+="<li>",d+='<div class="flat-slider-container">',d+='<label><span class="glyphicon glyphicon-adjust"></span><span class="command-name">Opacity: </span><span class="slider-value">100%</span></label>',d+='<div class="flat-slider-container">',d+='<input type="range" class="flat-slider layer-opacity-control" min="0" max="100" value="100" data-layer-id="'+r+'" data-layer-variable="">',d+="</div>",d+="</li></ul>",n.append(d),n.css({overflow:"visible"});var p=new ol.layer.Tile({source:new ol.source.TileWMS({url:s,params:{service:o,version:"1.3.0",request:"GetMap",LAYERS:c,TILED:!0},serverType:"geoserver"})});a[r]=p,ue(),t.addLayer(p),W(),b=$("input[name=csrfmiddlewaretoken]").val(),$.ajax({type:"POST",url:"",data:{method:"save_custom_layers",layer_name:l,uuid:r,service_link:s,service_type:o,service_layer_name:c},beforeSend:e=>{e.setRequestHeader("X-CSRFToken",b)}}).done(function(e){})})})},X=function(){c=$("#properties-popup"),d=$("#properties-popup-content"),p=$("#properties-popup-close-btn"),s=new ol.Overlay({element:c.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),t.addOverlay(s),p.on("click",function(){return K(),TETHYS_MAP_VIEW.clearSelection(),!1}),c.css("display","block"),TETHYS_MAP_VIEW.onSelectionChange(se);let e=TETHYS_MAP_VIEW.getSelectInteraction();e&&e.on("select",ie)},J=function(e){let t=e;e instanceof ol.geom.Point&&(t=e.getCoordinates()),s.setPosition(t)},K=function(){s.setPosition(void 0),p.blur()},Z=function(){d.empty(),K()},B=function(e){d.append(e)},ie=function(e){let t=e.selected;t.length>0&&D(t)},se=function(e,t,a){D([e,t,a])},D=function(e){let t=[];Q(!1);for(var a=0;a<e.length;a++){let o=e[a],n=[];if(o&&o instanceof ol.Feature)n=[o],t.push(compute_center(n));else{if(!(o&&o.getSource()&&o.getSource().getFeatures().length))continue;n=o.getSource().getFeatures(),t.push(compute_center(n))}for(var l=0;l<n.length;l++){let e=n[l],t=ee(e);B(t);let a=te(e);B(a);let o=A(e);B(o),C();let r=k(e);B(r),T()}}let o=compute_center(t);o&&J(o)},Q=function(e=!0){e&&TETHYS_MAP_VIEW.clearSelection(),Z(),I()},ee=function(e){let t=w(e),l=a[t],o="";return'<h6 class="properites-title">'+(o=l.hasOwnProperty("tethys_data")&&l.tethys_data.hasOwnProperty("popup_title")?l.tethys_data.popup_title:l.tethys_legend_title)+"</h6>"},te=function(e){let t=e.getProperties(),l=e.getGeometry(),o=l.getType().toLowerCase(),n="type"in t?t.type:o,r=w(e),i=a[r].tethys_data,s=["geometry","the_geom"];i.hasOwnProperty("excluded_properties")&&(s=s.concat(i.excluded_properties));let c='<tr><td>{{KEY}}</td><td>{{VALUE}}&nbsp;<span id="{{ELEMENT_CLASS}}-{{PROPERTY}}-units"></span></td></tr>';c=c.replace("{{ELEMENT_CLASS}}",n);let d='<table class="table table-condensed table-striped {{CLASS}}">{{ROWS}}</table>',p="";for(var u in s.includes("type")||(p+=c.replace("{{KEY}}","Type").replace("{{VALUE}}",l.getType()).replace("{{PROPERTY}}","type")),t){if(in_array(u,s))continue;let e=t[u];e instanceof Object?e.hasOwnProperty("type")&&e.hasOwnProperty("value")&&"dataset"==e.type?p+=ae(u,e.value):console.log("WARNING: Unable to load property row - "+var_to_title_case(u)+": "+e):p+=c.replace("{{KEY}}",var_to_title_case(u)).replace("{{VALUE}}",e).replace("{{PROPERTY}}",u)}return p.length?d=(d=d.replace("{{CLASS}}",n)).replace("{{ROWS}}",p):""},ae=function(e,t){let a="",l='<table class="table">',o=t.meta.columns,n=t.meta.length;a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",var_to_title_case(e));let r="";$.each(o,function(e,t){r+="<th>{{VALUE}}</th>".replace("{{VALUE}}",t)}),l+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",r);let i="";for(var s=0;s<n;s++){let e="";$.each(o,function(a,l){let o=t[l][s];e+="<td>{{VALUE}}</td>".replace("{{VALUE}}",o)}),i+="<tr>{{COLUMNS}}</tr>".replace("{{COLUMNS}}",e)}return l+=i,a+='<tr><td colspan="2">{{VALUE}}</td></tr>'.replace("{{VALUE}}",l+="</table>")},ve=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},le=function(){TETHYS_MAP_VIEW.overrideSelectionStyler("points",oe),TETHYS_MAP_VIEW.overrideSelectionStyler("lines",ne),TETHYS_MAP_VIEW.overrideSelectionStyler("polygons",re),n&&X()},oe=function(e,t){return[new ol.style.Style({image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#7300e5"}),stroke:new ol.style.Stroke({color:"white",width:1})})})]},ne=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},re=function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffffff",width:6}),fill:new ol.style.Fill({color:"rgba(115, 0, 229, 0.1)"})}),new ol.style.Style({stroke:new ol.style.Stroke({color:"#7300e5",width:4})})]},ye=function(){if(f){var e=$("#map-geocode-wrapper");$(".ol-overlaycontainer-stopevent").append(e);var t=$("#geocode_select");t.select2({minimumInputLength:3,placeholder:"Search",allowClear:!0,maximumSelectionLength:1,ajax:{url:".",delay:2e3,type:"POST",data:function(e){return{method:"find-location-by-query",q:e.term,extent:o.join()}},processResults:function(e,t){return r=e.results,{results:e.results}}}}),t.on("select2:select",fe),t.on("select2:unselect",me)}},fe=function(e){var a;if($("li.select2-search.select2-search--inline").addClass("geocode-item-selected"),is_defined(r)){for(a=0;a<r.length;a++)if(r[a].id==$(e.target).val()){var l=r[a].point,o=r[a].bbox,n=new ol.source.Vector({features:[new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(l,"EPSG:4326","EPSG:3857"))})]});if(is_defined(i))i.setSource(n);else{var s=new ol.style.Fill({color:"rgba(255,0,0,0.9)"}),c=new ol.style.Stroke({color:"rgba(255,255,255,1)",width:2}),d=new ol.style.Style({image:new ol.style.Circle({fill:s,stroke:c,radius:8}),fill:s,stroke:c});i=new ol.layer.Vector({source:n,style:d}),t.addLayer(i)}TETHYS_MAP_VIEW.zoomToExtent(o)}}else console.error("No Geocode objects defined.")},me=function(e){if($("li.select2-search.select2-search--inline").removeClass("geocode-item-selected"),is_defined(i)){var t=i.getSource(),a=t.getFeatures();if(null!=a&&a.length>0)for(var l in a)t.removeFeature(a[l])}},function(e,t,a){e[t]=a},function(e,t){if(he(e,t))return e[t]},he=function(e,t){return t in e},function(e,t){he(e,t)&&delete e[t]},ge=function(){var e=7;$(".tethys-map-view-draw-control").each(function(t,a){$(a).css("left",e+"px"),$(a).css("bottom","7px"),$(a).css("top","auto"),e+=42}),$('[data-toggle="tooltip"]').tooltip("destroy"),$('[data-toggle="tooltip"]').tooltip({placement:"top"})},e={properties_table_generator:function(e){te=e},action_button_generator:function(e){k=e},plot_button_generator:function(e){A=e},plot_loader:function(e){V=e},action_loader:function(e){L=e},get_layer_name_from_feature:w=function(e){let t=e.get("layer_name");if(!t){let a=e.getId();t=l+":"+a.split(".")[0]}return t},get_feature_id_from_feature:E=function(e){let t=e.getId(),a="-1";return a=t?t.split(".")[1]:e.get("id")},load_layers:function(e,l,o,n,r,i){var s=0;for(s=0;s<o.length;s++)a[r[s]]=o[s],t.addLayer(o[s]);var c="create";$("#"+l).length&&(c="append"),$.ajax({type:"POST",url:".",async:!1,data:{method:"build_layer_group_tree_item",status:c,layer_group_id:l,layer_group_name:e,layer_names:JSON.stringify(n),layer_ids:JSON.stringify(r),layer_legends:JSON.stringify(i)}}).done(function(e){"create"==c?$("#layers-tab-panel").prepend(e.response):$("#"+l+"_associated_layers").prepend(e.response)}),W()},remove_layer_from_map:S=function(e){t.removeLayer(a[e]),delete a[e]},init_layers_tab:W},$(function(){g(),h(),v(),_(),W(),ye(),P(),ge(),x()}),e}();