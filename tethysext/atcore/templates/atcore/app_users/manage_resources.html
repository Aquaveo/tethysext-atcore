{% extends base_template %}

{% load static tethys_gizmos %}

{% block app_content %}
  {% with tethys_app.namespace|add:':'|add:resource_slug as base_resource_href %}
    <div class="btn-toolbar top-action-btns float-end" role="toolbar" aria-label="Manage resources toolbar">
      <div class="btn-group me-2">
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle manage-action-btn btn-group" type="button" id="btn-group" data-bs-toggle="dropdown" aria-expanded="false" data-bs-placement="Bottom" title="Group">
            <i class="bi bi-collection"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" id="btn-add-to-existing-group" href="javascript:void(0);"><i class="bi bi-plus"></i> Add to Existing</a></li>
            <li><a class="dropdown-item" id="btn-new-from-selected" href="javascript:void(0);"><i class="bi bi-plus-square-dotted"></i> New from Selected</a></li>
          </ul>
        </div>
      </div>
      {% if show_new_button and resources %}
      <div class="btn-group me-2">  
        <a class="btn btn-outline-secondary manage-action-btn btn-new" href="{% url base_resource_href|add:'_new_resource' %}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="New"><span class="bi bi-plus-lg"></span></a>
      </div>
      {% endif %}
    </div>

    <h1>{{ page_title }}</h1>

    {% if resources %}
      {% include "atcore/pagination_template.html" with pagination_info=pagination_info where="header"  %}
      <div id="resources-list" class="mb-3">
        {# HEADERS #}
        <div class="row fw-bold resource-row-header">
          {# SELECT #}
          <div class="col-1">
          </div>

          {# NAME HEADER #}
          <div class="col">
            <span class="sortable" data-sort-field="name">Name</span>
            {% if 'name' in pagination_info.sort_by %}
            <span class="bi bi-sort-down{% if pagination_info.sort_reversed %}-alt{% endif %}"></span>
            {% endif %}
          </div>

          {# DESCRIPTION HEADER #}
          <div class="col-2">
            <span class="sortable" data-sort-field="description">Description</span>
            {% if 'description' in pagination_info.sort_by %}
            <span class="bi bi-sort-down{% if pagination_info.sort_reversed %}-alt{% endif %}"></span>
            {% endif %}
          </div>

          {# ORGANIZATION HEADER #}
          <div class="col">
            <span>Organizations</span>
          </div>

          {# CREATED BY HEADER #}
          <div class="col">
            <span class="sortable" data-sort-field="created_by">Created By</span>
            {% if 'created_by' in pagination_info.sort_by %}
            <span class="bi bi-sort-down{% if pagination_info.sort_reversed %}-alt{% endif %}"></span>
            {% endif %}
          </div>

          {# DATE CREATED HEADER #}
          <div class="col-2">
            <span class="sortable" data-sort-field="date_created">Date Created</span>
            {% if 'date_created' in pagination_info.sort_by %}
            <span class="bi bi-sort-down{% if pagination_info.sort_reversed %}-alt{% endif %}"></span>
            {% endif %}
          </div>

          {# DEBUGGING FIELDS #}
          {% if show_debugging_info %}
          <div class="col">
            <span class="sortable" data-sort-field="location">Debugging</span>
            {% if 'location' in pagination_info.sort_by %}
            <span class="bi bi-sort-down{% if pagination_info.sort_reversed %}-alt{% endif %}"></span>
            {% endif %}
          </div>
          {% endif %}

          {# BUTTONS HEADER #}
          <div class="col-2">
          </div>
        </div>
        {# RESOURCE ROWS #}
        {% for resource in resources %}
          {# TOP LEVEL RESOURCES HAVE NO PARENTS #}
          {% if not resource.has_parents %}
            {% include "atcore/components/resource_row.html" with resource=resource level=0 %}
          {% endif %}
        {% endfor %}
      </div>
      {% include "atcore/pagination_template.html" with pagination_info=pagination_info where="footer" %}
    {% else %}
      {% if show_new_button %}
      <div class="new-resource center-parent">
        <div class="centered">
          <h4>No {{ type_plural }} Found</h4>
          <a class="btn btn-primary btn-huge" href="{% url base_resource_href|add:'_new_resource' %}">Upload New {{ type_singular }}</a>
        </div>
      </div>
      {% else %}
      <div class="new-resource center-parent">
        <h4 class="centered">No {{ type_plural }} Available</h4>
      </div>
      {% endif %}
    {% endif %}
  {% endwith %}
{% endblock %}

{% block after_app_content %}
  {% if load_delete_modal %}
    {% csrf_token %}
    <!-- Delete Modal -->
    <div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="delete-modal-label">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="delete-modal-label">Delete {{ type_singular }}</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this {{ type_singular|lower }}? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <a id="modal-delete-button" class="btn btn-danger btn-delete-modal" href="javascript:void(0);" data-delete-type="resources">Delete</a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  <!-- Add to Existing Group Modal -->
  <div class="modal fade" id="add-to-existing-group-modal" tabindex="-1" role="dialog" aria-labelledby="new-group-from-selected-modal-label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="new-group-from-selected-modal-label">Add to Existing {{ type_singular }} Group</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this {{ type_singular|lower }}? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <a id="modal-delete-button" class="btn btn-success btn-add-to-group-modal" href="javascript:void(0);" data-delete-type="resources">Group</a>
        </div>
      </div>
    </div>
  </div>
  <!-- New Group from Selected Modal -->
  <div class="modal fade" id="new-group-from-selected-modal" tabindex="-1" role="dialog" aria-labelledby="new-group-from-selected-modal-label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="new-group-from-selected-modal-label">New {{ type_singular }} Group from Selected</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="new-group-from-selected-form">
            {% csrf_token %}
            <input type="text" name="action" value="new-group-from-selected" hidden>
            <div class="mb-3">
              <label for="new-group-resource-name" class="form-label">Name</label>
              <input type="text" class="form-control" id="new-group-resource-name" name="name">
            </div>
            <div class="mb-3">
              <label for="new-group-resource-description">Description</label>
              <textarea class="form-control" id="new-group-resource-description" name="description" rows=5></textarea>
            </div>
            <div class="mb-3">
              <label for="new-group-resources-select">{{ type_plural }} to Group</label>
              <select class="form-select resources-select" id="new-group-resources-select" name="children" multiple></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <a id="modal-new-group-button" class="btn btn-success btn-group-modal" href="javascript:void(0);">Create Group</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block app_actions %}
{% endblock %}

{% block styles %}
  {{ block.super }}
  <link href="{% static 'atcore/app_users/css/app_users.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/app_users/css/sort.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/css/center.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/css/flex.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/app_users/css/manage_resources.css' %}" rel="stylesheet"/>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'atcore/js/csrf.js' %}" type="text/javascript"></script>
  <script src="{% static 'atcore/js/delete_row.js' %}"></script>
  <script src="{% static 'atcore/app_users/js/sort.js' %}" type="text/javascript"></script>
  <script src="{% static 'atcore/resources/group_resources.js' %}" type="text/javascript"></script>
{% endblock %}

