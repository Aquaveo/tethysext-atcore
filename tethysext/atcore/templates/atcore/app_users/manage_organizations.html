{% extends "epanet/base.html" %}
{% load staticfiles tethys_gizmos %}

{# import tethys_gizmos.css for centering of loading gif #}
{% block import_gizmos %}
    {% import_gizmo_dependency toggle_switch %}
{% endblock %}

{% block app_content %}
  <div class="manage-container">
    <div class="top-action-buttons pull-right">
      {% if show_new_button %}
      <a class="btn btn-default manage-action-btn btn-new" href="{% url 'epanet:new_organization' %}" data-toggle="tooltip" data-placement="bottom" title="New"><span class="glyphicon glyphicon-plus"></span></a>
      {% endif %}
    </div>
    <h1>{% block organizations_title %}Organizations{% endblock %}</h1>

    {# ENTERPRISE #}
    {% if enterprise_org_cards %}
      {% if enterprise_org_cards and client_org_cards %}<h5>Enterprise Organizations</h5>{% endif %}
      <div class="panel-group" id="enterprise-cards" role="tablist" aria-multiselectable="true">
      {% for enterprise_card in enterprise_org_cards %}
        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="heading-{{ enterprise_card.id }}">
            {% if show_action_buttons %}
            <div class="manage-grid-actions pull-right">
              {% if show_modify_members_button %}
              <a class="btn btn-default btn-users" href="{% url 'epanet:manage_organization_members' enterprise_card.id %}?next=manage-organizations" data-toggle="tooltip" data-placement="top" title="Manage Members"><span class="glyphicon glyphicon-user"></span></a>
              {% endif %}
              {% if enterprise_card.modifiable or show_edit_enterprise_button %}
              <a class="btn btn-default btn-edit" href="{% url 'epanet:edit_organization' enterprise_card.id %}" data-toggle="tooltip" data-placement="top" title="Edit"><span class="glyphicon glyphicon-edit"></span></a>
              {% endif %}
              {% if enterprise_card.modifiable %}
              <a class="btn btn-default btn-delete-manage btn-delete" href="javascript:void(0);" data-id="{{ enterprise_card.id }}" data-toggle="tooltip" data-placement="top" title="Delete"><span class="glyphicon glyphicon-trash"></span></a>
              {% endif %}
            </div>
            {% endif %}
            <span class="manage-item-title">
              <a role="button"
                 data-toggle="collapse"
                 data-parent="#enterprise-cards"
                 href="#collapse-{{ enterprise_card.id }}"
                 aria-expanded="{% if expand_all or expand_enterprise and forloop.first %}true{% else %}false{% endif %}"
                 aria-controls="collapse-{{ enterprise_card.id }}"
              >
                {{ enterprise_card.name }}{% if request.user.is_staff %} ({{ enterprise_card.id }}){% endif%}
              </a>
            </span>
          </div>
          <div id="collapse-{{ enterprise_card.id }}" class="panel-collapse collapse {% if expand_all or expand_enterprise and forloop.first %}in{% endif %}" role="tabpanel" aria-labelledby="heading-{{ enterprise_card.id }}">
            <div class="panel-body list-group-panel-body">
              <ul class="list-group">
                <li class="list-group-item">
                  <p class="manage-section-title">LICENSE</p>
                  <span class="manage-tag member-tag">{{ enterprise_card.license }}</span>
                </li>
                  <li class="list-group-item">
                    <p class="manage-section-title">ADDONS</p>
                    {% for addon in enterprise_card.addons %}
                      {% if show_modify_addons_switches %}
                        <div style="display: flex; flex-flow: row nowrap; justify-content: space-between">
                          <span class="manage-tag">{{ addon.title }}</span>
                          <div>
                              {% gizmo toggle_switch addon.switch %}
                          </div>
                        </div>
                      {% else %}
                        {% if addon.enabled %}
                          <span class="manage-tag">{{ addon.title }}</span>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </li>
                <li class="list-group-item">
                  <p class="manage-section-title">MEMBERS</p>
                  {% for member in enterprise_card.members %}
                    {% if link_to_members %}
                    <a href="{% url 'epanet:edit_user' member.1 %}?next=manage-organizations"><span class="manage-tag member-tag">{% if member.0 == request.user.username %}Me{% else %}{{ member.0 }}{% endif %}</span></a>
                    {% else %}
                    <span class="manage-tag member-tag">{% if member.0 == request.user.username %}Me{% else %}{{ member.0 }}{% endif %}</span>
                    {% endif %}
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <p class="manage-section-title">PROJECTS</p>
                  {% for project in enterprise_card.projects %}
                  <a href="{% url 'epanet:project_details' project.1 %}"><span class="manage-tag project-tag">{{ project.0 }}</span></a>
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-md-8">
                      <p class="manage-section-title">STANDARD CLIENTS</p>
                    </div>
                    <div class="col-md-4">
                      {% if enterprise_card.modifiable %}
                      <div class="input-group spinner pull-right">
                        <input type="text" class="form-control max-clients-spinner" value="{{ enterprise_card.standard_client_stats.max }}" data-spinner-min="-1" data-spinner-max="" data-organization-id="{{ enterprise_card.id }}" data-access-level="standard">
                        <div class="input-group-btn-vertical">
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                        </div>
                      </div>
                      <div class="pull-right spinner-prefix">
                        <span>Used {{ enterprise_card.standard_client_stats.used }} of</span>
                      </div>
                      {% else %}
                      <div>
                        <span>Used {{ enterprise_card.standard_client_stats.used }} of {% if enterprise_card.standard_client_stats.max >= 0 %}{{ enterprise_card.standard_client_stats.max }}{% else %}Unlimited{% endif %}:</span>
                        <div class="progress">
                          <div class="progress-bar {% if enterprise_card.standard_client_stats.max < 0 %}progress-bar-success{% elif enterprise_card.standard_client_stats.over %}progress-bar-danger{% endif %}" role="progressbar" aria-valuenow="{{ enterprise_card.standard_client_stats.percentage }}" aria-valuemin="0" aria-valuemax="100"
                               style="width: {{ enterprise_card.standard_client_stats.percentage }}%; min-width: 2em;">
                            {% if enterprise_card.standard_client_stats.max < 0 %}
                            UNLIMITED
                            {% elif enterprise_card.standard_client_stats.over %}
                            OVER
                            {% else %}
                            {{ enterprise_card.standard_client_stats.percentage }}%
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% for client in enterprise_card.standard_clients %}
                  <span class="manage-tag project-tag">{{ client.name }}</span>
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-md-8">
                      <p class="manage-section-title">PROFESSIONAL CLIENTS</p>
                    </div>
                    <div class="col-md-4">
                      {% if enterprise_card.modifiable %}
                      <div class="input-group spinner pull-right">
                        <input type="text" class="form-control max-clients-spinner" value="{{ enterprise_card.professional_client_stats.max }}" data-spinner-min="-1" data-spinner-max="" data-organization-id="{{ enterprise_card.id }}" data-access-level="professional">
                        <div class="input-group-btn-vertical">
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                        </div>
                      </div>
                      <div class="pull-right spinner-prefix">
                        <span>Used {{ enterprise_card.professional_client_stats.used }} of</span>
                      </div>
                      {% else %}
                      <div>
                        <span>Used {{ enterprise_card.professional_client_stats.used }} of {% if enterprise_card.professional_client_stats.max >= 0 %}{{ enterprise_card.professional_client_stats.max }}{% else %}Unlimited{% endif %}:</span>
                        <div class="progress">
                          <div class="progress-bar {% if enterprise_card.professional_client_stats.max < 0 %}progress-bar-success{% elif enterprise_card.professional_client_stats.over %}progress-bar-danger{% endif %}" role="progressbar" aria-valuenow="{{ enterprise_card.professional_client_stats.percentage }}" aria-valuemin="0" aria-valuemax="100"
                               style="width: {{ enterprise_card.professional_client_stats.percentage }}%; min-width: 2em;">
                            {% if enterprise_card.professional_client_stats.max < 0 %}
                            UNLIMITED
                            {% elif enterprise_card.professional_client_stats.over %}
                            OVER
                            {% else %}
                            {{ enterprise_card.professional_client_stats.percentage }}%
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% for client in enterprise_card.professional_clients %}
                  <span class="manage-tag project-tag">{{ client.name }}</span>
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-md-6">
                      <p class="manage-section-title">STORAGE</p>
                    </div>
                    <div class="col-md-6">
                      {% if enterprise_card.modify_storage %}
                      <div class="pull-right spinner-suffix">
                        <span>GB</span>
                      </div>
                      <div class="input-group spinner pull-right">
                        <input type="text" class="form-control max-storage-spinner" value="{{ enterprise_card.storage.max }}" data-spinner-min="-1" data-spinner-max="" data-organization-id="{{ enterprise_card.id }}" data-access-level="storage">
                        <div class="input-group-btn-vertical">
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                        </div>
                      </div>
                      <div class="pull-right spinner-prefix">
                        <span>Used {{ enterprise_card.storage.used }} {{ enterprise_card.storage.used_units }} of</span>
                      </div>
                      {% else %}
                      <div>
                        <span>Used {{ enterprise_card.storage.used }} {{ enterprise_card.storage.used_units }} of {% if enterprise_card.storage.max >= 0 %}{{ enterprise_card.storage.max }} {{ enterprise_card.storage.max_units }}{% else %}Unlimited{% endif %}:</span>
                        <div class="progress">
                          <div class="progress-bar {% if enterprise_card.storage.max < 0 %}progress-bar-success{% elif enterprise_card.storage.over %}progress-bar-danger{% endif %}" role="progressbar" aria-valuenow="{{ enterprise_card.storage.percentage }}" aria-valuemin="0" aria-valuemax="100"
                               style="width: {{ enterprise_card.storage.percentage }}%; min-width: 2em;">
                            {% if enterprise_card.storage.max < 0 %}
                            UNLIMITED
                            {% elif enterprise_card.storage.over %}
                            OVER
                            {% else %}
                            {{ enterprise_card.storage.percentage }}%
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <table class="table table-striped table-condensed storage-table">
                        {% for project_storage in enterprise_card.storage.by_project %}
                        <tr>
                          <td>{{ project_storage.0 }}</td>
                          <td>{{ project_storage.1 }}</td>
                        </tr>
                        {% endfor %}
                      </table>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      {% endfor %}
      </div>
    {% endif %}

    {# CLIENTS #}
    {% if client_org_cards %}
      {% if enterprise_org_cards and client_org_cards %}<h5>Client Organizations</h5>{% endif %}
      <div class="panel-group" id="client-cards" role="tablist" aria-multiselectable="true">
        {% for client_card in client_org_cards %}
        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="heading-{{ client_card.id }}">
            {% if show_action_buttons %}
            <div class="manage-grid-actions pull-right">
              {% if show_modify_members_button %}
              <a class="btn btn-default btn-users" href="{% url 'epanet:manage_organization_members' client_card.id %}?next=manage-organizations" data-toggle="tooltip" data-placement="top" title="Manage Members"><span class="glyphicon glyphicon-user"></span></a>
              {% endif %}
              {% if show_edit_and_delete_client_buttons and client_card.modifiable %}
              <a class="btn btn-default btn-edit" href="{% url 'epanet:edit_organization' client_card.id %}" data-toggle="tooltip" data-placement="top" title="Edit"><span class="glyphicon glyphicon-edit"></span></a>
              <a class="btn btn-default btn-delete-manage btn-delete" data-id="{{ client_card.id }}" data-toggle="tooltip" data-placement="top" title="Delete"><span class="glyphicon glyphicon-trash"></span></a>
              {% endif %}
            </div>
            {% endif %}
            <span class="manage-item-title">
              <a role="button"
                 data-toggle="collapse"
                 data-parent="#client-cards"
                 href="#collapse-{{ client_card.id }}"
                 aria-expanded="{% if expand_all and forloop.first %}true{% else %}false{% endif %}"
                 aria-controls="collapse-{{ client_card.id }}"
              >
                {{ client_card.name }}{% if request.user.is_staff %} ({{ client_card.id }}){% endif%}
              </a>
            </span>
          </div>
          <div id="collapse-{{ client_card.id }}" class="panel-collapse collapse {% if expand_all and forloop.first %}in{% endif %}" role="tabpanel" aria-labelledby="heading-{{ client_card.id }}">
            <div class="panel-body list-group-panel-body">
              <ul class="list-group">
                <li class="list-group-item">
                  <p class="manage-section-title">LICENSE</p>
                  <p><span class="manage-tag member-tag">{{ client_card.license }}</span></p>
                </li>
                <li class="list-group-item">
                  <p class="manage-section-title">ADDONS</p>
                  {% for addon in client_card.addons %}
                    {% if show_modify_addons_switches %}
                      <div style="display: flex; flex-flow: row nowrap; justify-content: space-between">
                        <span class="manage-tag">{{ addon.title }}</span>
                        <div>
                          {% gizmo toggle_switch addon.switch %}
                        </div>
                      </div>
                    {% else %}
                      {% if addon.enabled %}
                        <span class="manage-tag">{{ addon.title }}</span>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <p class="manage-section-title">MEMBERS</p>
                  {% for member in client_card.members %}
                    {% if link_to_members %}
                    <a href="{% url 'epanet:edit_user' member.1 %}?next=manage-organizations"><span class="manage-tag member-tag">{% if member.0 == request.user.username %}Me{% else %}{{ member.0 }}{% endif %}</span></a>
                    {% else %}
                    <span class="manage-tag member-tag">{% if member.0 == request.user.username %}Me{% else %}{{ member.0 }}{% endif %}</span>
                    {% endif %}
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <p class="manage-section-title">PROJECTS</p>
                  {% for project in client_card.projects %}
                  <a href="{% url 'epanet:project_details' project.1 %}"><span class="manage-tag project-tag">{{ project.0 }}</span></a>
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <p class="manage-section-title">CONSULTANT</p>
                  {% for owner in client_card.owners %}
                  <p><span class="manage-tag project-tag">{{ owner.name }}</span></p>
                  {% endfor %}
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-md-6">
                      <p class="manage-section-title">STORAGE</p>
                    </div>
                    <div class="col-md-6">
                      {% if client_card.modify_storage %}
                      <div class="pull-right spinner-suffix">
                        <span>GB</span>
                      </div>
                      <div class="input-group spinner pull-right">
                        <input type="text" class="form-control max-storage-spinner" value="{{ client_card.storage.max }}" data-spinner-min="-1" data-spinner-max="" data-organization-id="{{ client_card.id }}" data-access-level="storage">
                        <div class="input-group-btn-vertical">
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>
                          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                        </div>
                      </div>
                      <div class="pull-right spinner-prefix">
                        <span>Used {{ client_card.storage.used }} {{ client_card.storage.used_units }} of</span>
                      </div>
                      {% else %}
                      <div>
                        <span>Used {{ client_card.storage.used }} {{ client_card.storage.used_units }} of {% if client_card.storage.max >= 0 %}{{ client_card.storage.max }} {{ client_card.storage.max_units }}{% else %}Unlimited{% endif %}:</span>
                        <div class="progress">
                          <div class="progress-bar {% if client_card.storage.max < 0 %}progress-bar-success{% elif client_card.storage.over %}progress-bar-danger{% endif %}" role="progressbar" aria-valuenow="{{ client_card.storage.percentage }}" aria-valuemin="0" aria-valuemax="100"
                               style="width: {{ client_card.storage.percentage }}%; min-width: 2em;">
                            {% if client_card.storage.max < 0 %}
                            UNLIMITED
                            {% elif client_card.storage.over %}
                            OVER
                            {% else %}
                            {{ client_card.storage.percentage }}%
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <table class="table table-striped table-condensed storage-table">
                        {% for project_storage in client_card.storage.by_project %}
                        <tr>
                          <td>{{ project_storage.0 }}</td>
                          <td>{{ project_storage.1 }}</td>
                        </tr>
                        {% endfor %}
                      </table>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block after_app_content %}
  {% if show_action_buttons %}
  <!-- Delete Modal -->
  <div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="delete-modal-label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="delete-modal-label">Delete Organization</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this organization? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <a id="modal-delete-button" class="btn btn-danger" href="javascript:void(0);" data-delete-type="organizations">Delete</a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

{% block styles %}
  {{ block.super }}
  <link href="{% static 'atcore/app_users/css/manage.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/app_users/css/collapse_list_group.css' %}" rel="stylesheet"/>
  <link href="{% static 'atcore/boostrap_spinner/css/bootstrap_spinner.css' %}" rel="stylesheet"/>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'atcore/js/csrf.js' %}"></script>
  <script src="{% static 'atcore/app_users/js/manage.js' %}"></script>
  <script src="{% static 'atcore/boostrap_spinner/js/bootstrap_spinner.js' %}"></script>
  <script src="{% static 'atcore/app_users/js/organizations.js' %}"></script>
{% endblock %}