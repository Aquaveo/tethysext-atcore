{% extends "atcore/resource_workflows/workflow_results_view.html" %}
{% load tethys_gizmos static %}

{% block app_content_wrapper_override %}
  {{ block.super }}
  <input type="button" value="Print Report" id="btnPrint" class="btn btn-info" style="position:absolute;right:20px;top:70px;"/>
  <script type="text/javascript">
    $("#btnPrint").on("click", function() {
      let curURL = window.location.href;
      history.replaceState(history.state, '', '/report');
      window.print();
      history.replaceState(history.state, '', curURL);
    });
  </script>
{% endblock %}

{% block content_dependent_styles %}
  {{ block.super }}
  <link href="{% static 'atcore/resource_workflows/report_workflow_results_view.css' %}" rel="stylesheet"/>
{% endblock %}

{% block import_gizmos %}
  {{ block.super }}
  {% import_gizmo_dependency plotly_view %}
  {% import_gizmo_dependency bokeh_view %}
  {% import_gizmo_dependency datatable_view %}
  {% import_gizmo_dependency map_view %}
{% endblock %}

{% block app_content %}
  {{ block.super }}

  <form id="report_form">
  <div id="report_workflow_data">
    {% if has_tabular_data %}
      <div class="tab-data">
        {% for tab_data_title, tab_data in tabular_data.items %}
        <h2>{{ tab_data_title }}</h2>
        {% for parameter, value in tab_data.items %}
        <p><b>{{ parameter|title }}:</b> {{ value }}</p>
        {% endfor %}
        {% endfor %}
      </div>
    {% endif %}
    <div contentEditable=true class="add-border" data-ph="General Note"></div>
    {% for result in report_results %}
      {% for type, value in result.items %}
        {% if type == 'map' %}
          <div id="resultType-map-{{ forloop.parentloop.counter }}" class="resultType-map" data-layer-url="{{ value.map.options.url|safe }}" data-layer-params="{{ value.map.options.params|safe }}" data-layer-extent="{{ value.map.legend_extent }}">
          <h3>{{ value.name }}</h3>
          {% if value.description %}
            <h4>Description: {{ value.description }}</h4>
          {% endif %}
          <div class="container-fluid">
            <div class="row">
              <div class="col-xs-8 nopadding" id="openLayerMap{{ forloop.parentloop.counter }}" class='map-view-result'></div>
              {% if value.legend %}
                <div class="col-xs-4" id="legend-{{ value.legend.legend_id }}" style="width:220px;">
                  <li class="legend-group-item" style="list-style-type:none;">
                    <label class="flatmark">
                      <span class="display-name">
                        {{ value.legend.title|title }}{% if value.legend.units %} ({{value.legend.units}}){% endif %}
                      </span>
                    </label>
                  </li>
                  <ul class="legend-list" data-collapsed="false">
                    {% for division, color in value.legend.divisions.items  %}
                      <div class="legend-item">
                        <li class="legend-list-item">
                          <p>{{ division }} </p>
                          <div class="color-box" style="background-color: {{ color }} !important;"></div>
                        </li>
                      </div>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </div>
          </div>
          <div contentEditable=true class="add-border" data-ph="Map Note"></div>
          </div>
        {% elif type == 'dataset' %}
          <div id="resultType-table-{{ forloop.counter }}">
            <h3>{{ value.title }}</h3>
            {% if value.data_description %}
              <h4>Description: {{ value.data_description }}</h4>
            {% endif %}
            <div>
              {% gizmo value.data_table %}
            </div>
            <div contentEditable=true class="add-border" data-ph="Data Note"></div>
          </div>
        {% elif type == 'plot' %}
          <div id="resultType-plot-{{ forloop.counter }}">
            <h3>{{ value.name }}</h3>
            {% if value.description %}
              <h4>Description: {{ value.description }}</h4>
            {% endif %}
              <div id="resultPlotDiv{{ forloop.counter }}" style="width:800px;">
                {% gizmo value.plot %}
              </div>
            </div>
            <div contentEditable=true class="add-border" data-ph="Plot Note"></div>
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  </form>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'atcore/resource_workflows/report_workflow_results_view.js' %}" type="text/javascript"></script>
{% endblock %}
