{% extends "atcore/resource_workflows/workflow_results_view.html" %}
{% load tethys_gizmos static %}

{% block app_content_wrapper_override %}
  {{ block.super }}
  <input type="button" value="Print Report" id="btnPrint" class="btn btn-info" style="position:absolute;right:20px;top:70px;"/>
  <script type="text/javascript">
    $("#btnPrint").on("click", function() {
      let curURL = window.location.href;
      history.replaceState(history.state, '', '/report');
      window.print();
      history.replaceState(history.state, '', curURL);
    });
  </script>
{% endblock %}

{% block content_dependent_styles %}
  {{ block.super }}
  <link href="{% static 'atcore/resource_workflows/report_workflow_results_view.css' %}" rel="stylesheet"/>
{% endblock %}

{% block import_gizmos %}
  {{ block.super }}
  {% import_gizmo_dependency plotly_view %}
  {% import_gizmo_dependency bokeh_view %}
  {% import_gizmo_dependency datatable_view %}
  {% import_gizmo_dependency map_view %}
{% endblock %}

{% block app_content %}
  {{ block.super }}

  <form id="report_form">
  <div id="report_workflow_data">
    {% if has_tabular_data %}
      <div class="tab-data">
        {% for tab_data_title, tab_data in tabular_data.items %}
        <h2>{{ tab_data_title }}</h2>
        {% for k, v in tab_data.items %}
        <p><b>{{ k|title }}:</b> {{ v }}</p>
        {% endfor %}
        {% endfor %}
      </div>
    {% endif %}
    <div contentEditable=true class="add-border" data-ph="General Note"></div>
    <!-- Try to find a way to move the script (one line below) into the component. -->
    <script>
      var maps = [];
      var wmsSources = [];
      var extents = [];
    </script>
    {% for result in report_results %}
      {% for k, v in result.items %}
        {% if k == 'map' %}
          <div id="resultType-map-{{ forloop.parentloop.counter }}">
          <h3>{{ v.0 }}</h3>
          {% if v.1 %}
            <h4>Description: {{ v.1 }}</h4>
          {% endif %}
          <div class="container-fluid">
            <div class="row">
            {% set map_layer = v.3 %}
            {% set legend = v.2 %}
            {% include "./components/report_workflow_map_component.html" %}
            </div>
          </div>
          <div contentEditable=true class="add-border" data-ph="Map Note"></div>
          </div>
        {% elif k == 'dataset' %}
          <div id="resultType-table-{{ forloop.counter }}">
            <h3>{{ v.title }}</h3>
            {% if v.data_description %}
              <h4>Description: {{ v.data_description }}</h4>
            {% endif %}
            <div>
              {% gizmo v.data_table %}
            </div>
            <div contentEditable=true class="add-border" data-ph="Data Note"></div>
          </div>
        {% elif k == 'plot' %}
          <div id="resultType-plot-{{ forloop.counter }}">
            <h3>{{ v.0 }}</h3>
            {% if v.1 %}
              <h4>Description: {{ v.1 }}</h4>
            {% endif %}
              <div id="resultPlotDiv{{ forloop.counter }}" style="width:800px;">
                {% gizmo v.2 %}
              </div>
            </div>
            <div contentEditable=true class="add-border" data-ph="Plot Note"></div>
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  </form>
{% endblock %}
